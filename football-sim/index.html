import os, textwrap, zipfile, json, math, random, re, pathlib
base_dir = "/mnt/data/football-sim-v05"
os.makedirs(base_dir, exist_ok=True)

index_html = r"""<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gridiron Career Sim v0.5</title>
  <link rel="stylesheet" href="./style.css?v=5" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Gridiron Career Sim</h1>
          <p class="muted">High School → College → Draft → Pros • deep career sim foundation v0.5</p>
        </div>
      </div>
      <div class="top-actions">
        <button id="btnContinue" class="ghost" type="button">Continue</button>
        <button id="btnNew" class="primary" type="button">New Career</button>
        <button id="btnWipe" class="danger ghost" type="button">Wipe Save</button>
      </div>
    </header>

    <!-- SCREEN: Home -->
    <section class="card screen" id="screen-home">
      <h2>Home</h2>
      <p class="muted">Start a new career or continue where you left off.</p>

      <div class="grid2">
        <div class="panel">
          <h3>What’s in this build</h3>
          <ul class="list">
            <li><b>High School</b> • 4 years • 12 games/year • grades + social</li>
            <li><b>HS Playoffs</b> • 8-team bracket → State Championship</li>
            <li><b>Recruiting</b> • stars (1–5) + national rank • position-based needs • competing commits</li>
            <li><b>College</b> • conferences + standings • bowls + playoff selection</li>
            <li><b>Money + Gear</b> • work in college • buy/equip gear for boosts (carry to pros)</li>
            <li><b>Draft</b> • projection starts Junior year • combine invite • interviews • undrafted possible</li>
            <li><b>Pros</b> • 32 teams • 17-game season (+bye) • NFL-style playoffs (7/team conference)</li>
            <li><b>Contracts</b> • rookie deal • extensions • free agency eligibility after 3 seasons</li>
            <li><b>Luxury spending</b> • houses/vehicles/jewelry (no boosts)</li>
          </ul>
        </div>

        <div class="panel">
          <h3>How to play</h3>
          <ol class="list">
            <li>Create your player + HS team.</li>
            <li>Each week: choose actions (Train/Study/Social/Work) then Advance Week.</li>
            <li>Games simulate automatically on game weeks.</li>
            <li>Earn college offers, commit, play college seasons, declare for draft (Junior year optional).</li>
            <li>Play through draft → pro seasons → contracts/free agency.</li>
          </ol>
          <div class="hr"></div>
          <div class="muted small">Tip: Open DevTools Console for extra logs if you’re debugging.</div>
        </div>
      </div>
    </section>

    <!-- SCREEN: Builder -->
    <section class="card screen hidden" id="screen-builder">
      <div class="screen-head">
        <h2>Build Your Player</h2>
        <div class="muted">Step <span id="builderStep">1</span> / 3</div>
      </div>

      <div class="builder-step" data-step="1">
        <h3>Identity</h3>
        <div class="row">
          <label>
            Name
            <input id="bName" placeholder="e.g., Kenny McEachin" />
          </label>

          <label>
            Position
            <select id="bPos">
              <option value="QB">QB</option>
              <option value="RB">RB</option>
              <option value="WR">WR</option>
              <option value="TE">TE</option>
              <option value="CB">CB</option>
              <option value="LB">LB</option>
              <option value="DL">DL</option>
            </select>
          </label>

          <label>
            Handedness
            <select id="bHand">
              <option value="Right">Right</option>
              <option value="Left">Left</option>
            </select>
          </label>
        </div>

        <div class="row">
          <label>
            Hometown
            <input id="bTown" placeholder="City, State" />
          </label>

          <label>
            High School Team Name
            <input id="bHSTeam" placeholder="e.g., Lake Wales Highlanders" />
          </label>
        </div>
      </div>

      <div class="builder-step hidden" data-step="2">
        <h3>Physicals</h3>
        <div class="row">
          <label>
            Height
            <select id="bHeight"></select>
          </label>

          <label>
            Weight (lbs)
            <input id="bWeight" type="number" min="150" max="380" value="210" />
          </label>

          <label>
            Age (start of HS)
            <input id="bAge" type="number" min="14" max="18" value="15" />
          </label>
        </div>
        <p class="muted">Physicals influence baselines and performance.</p>
      </div>

      <div class="builder-step hidden" data-step="3">
        <h3>Archetype + Ratings</h3>

        <div class="row">
          <label>
            Archetype
            <select id="bArch"></select>
          </label>

          <div class="panel mini">
            <div class="muted">Points remaining</div>
            <div class="big" id="pointsLeft">0</div>
          </div>

          <div class="panel mini">
            <div class="muted">Overall (OVR)</div>
            <div class="big" id="ovrPreview">0</div>
          </div>
        </div>

        <div class="ratings">
          <div class="rating">
            <div class="rating-head"><b>Speed</b> <span class="muted" id="capSpeed"></span></div>
            <div class="rating-controls">
              <button class="ghost" type="button" data-attr="speed" data-dir="-1">-</button>
              <div class="num" id="valSpeed">0</div>
              <button type="button" data-attr="speed" data-dir="1">+</button>
            </div>
          </div>

          <div class="rating">
            <div class="rating-head"><b>Strength</b> <span class="muted" id="capStrength"></span></div>
            <div class="rating-controls">
              <button class="ghost" type="button" data-attr="strength" data-dir="-1">-</button>
              <div class="num" id="valStrength">0</div>
              <button type="button" data-attr="strength" data-dir="1">+</button>
            </div>
          </div>

          <div class="rating">
            <div class="rating-head"><b>Agility</b> <span class="muted" id="capAgility"></span></div>
            <div class="rating-controls">
              <button class="ghost" type="button" data-attr="agility" data-dir="-1">-</button>
              <div class="num" id="valAgility">0</div>
              <button type="button" data-attr="agility" data-dir="1">+</button>
            </div>
          </div>

          <div class="rating">
            <div class="rating-head"><b>Awareness</b> <span class="muted" id="capAwareness"></span></div>
            <div class="rating-controls">
              <button class="ghost" type="button" data-attr="awareness" data-dir="-1">-</button>
              <div class="num" id="valAwareness">0</div>
              <button type="button" data-attr="awareness" data-dir="1">+</button>
            </div>
          </div>

          <div class="rating">
            <div class="rating-head"><b>Stamina</b> <span class="muted" id="capStamina"></span></div>
            <div class="rating-controls">
              <button class="ghost" type="button" data-attr="stamina" data-dir="-1">-</button>
              <div class="num" id="valStamina">0</div>
              <button type="button" data-attr="stamina" data-dir="1">+</button>
            </div>
          </div>
        </div>

        <p class="muted">Rookie caps keep the build balanced.</p>
      </div>

      <div class="screen-foot">
        <button id="btnBack" class="ghost" type="button">Back</button>
        <div class="spacer"></div>
        <button id="btnNext" class="primary" type="button">Next</button>
      </div>
    </section>

    <!-- SCREEN: Career -->
    <section class="card screen hidden" id="screen-career">
      <div class="screen-head">
        <h2>Career Hub</h2>
        <div class="muted" id="careerSub"></div>
      </div>

      <div class="tabs">
        <button class="tabbtn primary" id="tabOverview" type="button" data-tab="overview">Overview</button>
        <button class="tabbtn ghost" id="tabSeason" type="button" data-tab="season">Season</button>
        <button class="tabbtn ghost" id="tabRecruit" type="button" data-tab="recruit">Recruiting</button>
        <button class="tabbtn ghost" id="tabShop" type="button" data-tab="shop">Shop</button>
        <button class="tabbtn ghost" id="tabContract" type="button" data-tab="contract">Contracts</button>
        <button class="tabbtn ghost" id="tabLogs" type="button" data-tab="logs">Log</button>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>Player</h3>
          <div id="playerCard" class="kv"></div>

          <div class="hr"></div>

          <h3>Life</h3>
          <div class="kv">
            <div><b>Grades</b> <span class="muted" id="gradesText"></span></div>
            <div class="bar"><div class="fill" id="gradesBar"></div></div>

            <div style="margin-top:10px;"><b>Social</b> <span class="muted" id="socialText"></span></div>
            <div class="bar"><div class="fill" id="socialBar"></div></div>

            <div style="margin-top:10px;"><b>Fatigue</b> <span class="muted" id="fatigueText"></span></div>
            <div class="bar"><div class="fill" id="fatigueBar"></div></div>

            <div style="margin-top:10px;">
              <b>Money</b> <span class="muted" id="moneyText"></span>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button id="btnTrain" type="button">Train</button>
            <button id="btnStudy" class="ghost" type="button">Study</button>
            <button id="btnSocial" class="ghost" type="button">Social</button>
            <button id="btnWork" class="ghost" type="button">Work</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnAdvanceWeek" class="primary" type="button">Advance Week</button>
            <button id="btnSave" class="ghost" type="button">Save</button>
          </div>
        </div>

        <div class="panel">
          <div id="tabContent"></div>
        </div>
      </div>
    </section>

    <footer class="muted">v0.5 • <span id="jsStatus">loading…</span></footer>
  </div>

  <script src="./game.js?v=5" defer></script>
</body>
</html>
"""

style_css = r""":root{
  --bg:#070b1a;
  --bg2:#0b1026;
  --card:rgba(255,255,255,.07);
  --border:rgba(255,255,255,.14);
  --text:#e7e9ee;
  --muted:rgba(231,233,238,.7);
  --accent:#7c5cff;
  --danger:#ff4d6d;
  --warn:#ffc43d;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 20% 0%, #1a1f3f 0%, var(--bg) 55%),
    radial-gradient(900px 600px at 90% 30%, #231a40 0%, var(--bg2) 60%);
  min-height:100vh;
}

.app{max-width:1120px;margin:0 auto;padding:22px}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  margin-bottom:16px;
}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:46px;height:46px;border-radius:14px;
  background:linear-gradient(135deg, rgba(124,92,255,.9), rgba(124,92,255,.2));
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 10px 30px rgba(124,92,255,.18);
}

h1{margin:0;font-size:20px}
h2{margin:0 0 10px}
h3{margin:0 0 8px}
.muted{color:var(--muted)}
.small{font-size:12px}
.big{font-size:26px;font-weight:800}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin:14px 0;
  backdrop-filter: blur(10px);
}

.screen-head, .screen-foot{
  display:flex;align-items:center;gap:12px;
}
.screen-foot{margin-top:14px}
.spacer{flex:1}
.hidden{display:none}

.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.grid{display:grid;grid-template-columns:420px 1fr;gap:14px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:980px){
  .topbar{flex-direction:column;align-items:flex-start}
  .grid{grid-template-columns:1fr}
  .grid2{grid-template-columns:1fr}
}

label{display:flex;flex-direction:column;gap:6px;min-width:230px}

input,select{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.25);
  color:var(--text);
  outline:none;
}

button{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(124,92,255,.20);
  color:var(--text);
  cursor:pointer;
  transition:transform .05s ease, border-color .2s ease, background .2s ease;
}
button:active{transform:translateY(1px)}
button:hover{border-color:rgba(124,92,255,.55)}
button.primary{background:rgba(124,92,255,.35)}
button.ghost{background:rgba(255,255,255,.06)}
button.danger{border-color:rgba(255,77,109,.55); color:#ffd5dd}
button.danger:hover{border-color:rgba(255,77,109,.9)}
button.warn{border-color:rgba(255,196,61,.6)}
button.warn:hover{border-color:rgba(255,196,61,.9)}

.panel{
  background:rgba(0,0,0,.22);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}

.panel.mini{min-width:180px}

.list{margin:8px 0 0 18px}

.kv div{margin:6px 0}

.ratings{
  display:grid;
  grid-template-columns:repeat(2, minmax(240px, 1fr));
  gap:10px;
  margin-top:10px;
}
@media (max-width:700px){.ratings{grid-template-columns:1fr}}

.rating{
  background:rgba(0,0,0,.22);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
}
.rating-head{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:8px;
}
.rating-controls{
  display:flex;align-items:center;gap:10px;
}
.num{
  min-width:46px;
  text-align:center;
  font-weight:800;
  font-size:18px;
  padding:6px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
}

.hr{
  border-top:1px solid rgba(255,255,255,.12);
  margin:12px 0;
}
.bar{
  height:12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.22);
  overflow:hidden;
}
.fill{
  height:100%;
  width:50%;
  background:rgba(124,92,255,.55);
}

.tabs{
  display:flex;gap:8px;flex-wrap:wrap;
  margin:10px 0 14px;
}
.tabbtn{padding:8px 10px;border-radius:999px;font-size:13px}

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
}
.table th,.table td{
  padding:8px;
  border-bottom:1px solid rgba(255,255,255,.10);
  vertical-align:top;
}
.pill{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  font-size:12px;
}
.pill.good{border-color:rgba(124,92,255,.6)}
.pill.warn{border-color:rgba(255,196,61,.6)}
.pill.bad{border-color:rgba(255,77,109,.6)}

.log{
  height:360px;
  overflow:auto;
  background:rgba(0,0,0,.25);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  margin-top:10px;
  white-space:pre-wrap;
}
"""

game_js = r"""/* Gridiron Career Sim v0.5
   HS playoffs bracket + recruiting competition + college conferences/bowls/playoffs
   Full 32-team pro league + 17-game season (+bye) + 7-team conference playoffs
   Contracts + free agency eligibility after 3 seasons
*/

const $ = (id) => document.getElementById(id);
const SAVE_KEY = "gridiron_career_v05";

const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
const rnd = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
const chance = (p) => Math.random() < p;
const fmtMoney = (n) => `$${Math.max(0, Math.floor(n)).toLocaleString()}`;

function logLine(msg){
  const el = state.ui?.logEl || null;
  if(el){
    el.textContent = `${msg}\n` + (el.textContent || "");
  }
  // also to console for debugging
  console.log("[GCS]", msg);
}

function showScreen(name){
  ["home","builder","career"].forEach(s=>{
    const el = $(`screen-${s}`);
    el.classList.toggle("hidden", s !== name);
  });
}

function save(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  logLine("Saved.");
}
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return false;
  try{
    state = JSON.parse(raw);
    return !!state?.player;
  }catch{
    return false;
  }
}
function wipe(){
  localStorage.removeItem(SAVE_KEY);
  state = makeNewCareer();
  showScreen("home");
}

/* ---------------- Data ---------------- */
const POSITIONS = ["QB","RB","WR","TE","CB","LB","DL"];

const ARCHETYPES = {
  QB: [
    { id:"FieldGeneral", name:"Field General", boosts:{ awareness:+6 }, caps:{ speed:85, strength:78, agility:84, awareness:95, stamina:90 } },
    { id:"Scrambler", name:"Scrambler", boosts:{ speed:+6, agility:+4 }, caps:{ speed:92, strength:76, agility:92, awareness:90, stamina:90 } },
    { id:"StrongArm", name:"Strong Arm", boosts:{ strength:+6 }, caps:{ speed:86, strength:88, agility:84, awareness:92, stamina:90 } },
  ],
  RB: [
    { id:"Elusive", name:"Elusive Back", boosts:{ speed:+6, agility:+6 }, caps:{ speed:95, strength:82, agility:95, awareness:88, stamina:92 } },
    { id:"Power", name:"Power Back", boosts:{ strength:+8 }, caps:{ speed:90, strength:92, agility:86, awareness:86, stamina:95 } },
    { id:"Receiving", name:"Receiving Back", boosts:{ agility:+6, awareness:+4 }, caps:{ speed:93, strength:80, agility:92, awareness:92, stamina:90 } },
  ],
  WR: [
    { id:"DeepThreat", name:"Deep Threat", boosts:{ speed:+8 }, caps:{ speed:96, strength:78, agility:92, awareness:88, stamina:90 } },
    { id:"RouteRunner", name:"Route Runner", boosts:{ agility:+8, awareness:+4 }, caps:{ speed:93, strength:76, agility:96, awareness:92, stamina:90 } },
    { id:"Physical", name:"Physical", boosts:{ strength:+6 }, caps:{ speed:92, strength:88, agility:88, awareness:88, stamina:92 } },
  ],
  TE: [
    { id:"Vertical", name:"Vertical Threat", boosts:{ speed:+4, awareness:+2 }, caps:{ speed:88, strength:90, agility:86, awareness:90, stamina:92 } },
    { id:"Blocking", name:"Blocking TE", boosts:{ strength:+8, stamina:+4 }, caps:{ speed:84, strength:95, agility:82, awareness:88, stamina:96 } },
  ],
  CB: [
    { id:"Man", name:"Man-to-Man", boosts:{ speed:+6, agility:+6 }, caps:{ speed:96, strength:74, agility:96, awareness:90, stamina:90 } },
    { id:"Zone", name:"Zone", boosts:{ awareness:+8 }, caps:{ speed:92, strength:74, agility:92, awareness:95, stamina:90 } },
  ],
  LB: [
    { id:"RunStopper", name:"Run Stopper", boosts:{ strength:+8, stamina:+2 }, caps:{ speed:88, strength:95, agility:86, awareness:92, stamina:96 } },
    { id:"Coverage", name:"Coverage LB", boosts:{ speed:+4, awareness:+6 }, caps:{ speed:90, strength:90, agility:90, awareness:95, stamina:94 } },
  ],
  DL: [
    { id:"PowerRusher", name:"Power Rusher", boosts:{ strength:+10 }, caps:{ speed:84, strength:96, agility:84, awareness:90, stamina:94 } },
    { id:"SpeedRusher", name:"Speed Rusher", boosts:{ speed:+4, agility:+4 }, caps:{ speed:88, strength:92, agility:88, awareness:88, stamina:92 } },
  ]
};

// Colleges: 60 teams across 10 conferences, 1–5 stars.
const CONFERENCES = [
  { id:"ATL", name:"Atlantic", tier:"Power" },
  { id:"PAC", name:"Pacific", tier:"Power" },
  { id:"MID", name:"Midwest", tier:"Power" },
  { id:"SOU", name:"Southern", tier:"Power" },
  { id:"MET", name:"Metro", tier:"Power" },
  { id:"MNT", name:"Mountain", tier:"G5" },
  { id:"COA", name:"Coastal", tier:"G5" },
  { id:"PLA", name:"Plains", tier:"G5" },
  { id:"NOR", name:"Northern", tier:"G5" },
  { id:"SUN", name:"Sun Belt", tier:"G5" },
];

function makeColleges(){
  const names5 = ["Alpine University","Atlantic State","Pacific Tech","Capital A&M","Grandview"];
  const names4 = ["Riverview","Midland","Gulf Coast U","Ironwood","Red Rock"];
  const names3 = ["North Valley","Desert State","Cypress College","Lakeside U","Bayfront"];
  const names2 = ["Pine Ridge","Southern Plains","Harbor State","Stonebridge","Evergreen"];
  const names1 = ["Hillcrest","Lakeview","Cedar Point","Summit Valley","Westhaven"];

  const out = [];
  let idx = 1;

  function pushMany(names, stars, count){
    for(let i=0;i<count;i++){
      const baseName = names[i % names.length];
      const name = `${baseName} ${idx<=9?"":" "}${idx}`.replace(/\s+/g," ").trim();
      idx++;
      const prestige = clamp(45 + stars*10 + rnd(-4,4), 45, 98);
      out.push({ id:`C${idx}${stars}`, name, stars, prestige, confId:null });
    }
  }

  pushMany(names5, 5, 10);
  pushMany(names4, 4, 14);
  pushMany(names3, 3, 14);
  pushMany(names2, 2, 12);
  pushMany(names1, 1, 10);

  // Assign conferences round-robin, bias Power for higher stars.
  const power = CONFERENCES.filter(c=>c.tier==="Power").map(c=>c.id);
  const g5 = CONFERENCES.filter(c=>c.tier==="G5").map(c=>c.id);

  let pi=0, gi=0;
  for(const c of out){
    if(c.stars >= 4){
      c.confId = power[pi++ % power.length];
    }else if(c.stars === 3){
      c.confId = chance(0.65) ? power[pi++ % power.length] : g5[gi++ % g5.length];
    }else{
      c.confId = g5[gi++ % g5.length];
    }
  }

  return out;
}
const COLLEGES = makeColleges();

// Shop items: gear boosts carry to pros; clothes boost social; services boost grades.
const SHOP_ITEMS = [
  { id:"cleats1", name:"Performance Cleats", type:"equipment", cost:350, effects:{ speed:+1 }, social:+0, equipSlot:"feet", desc:"+1 Speed (equipped)" },
  { id:"cleats2", name:"Elite Cleats", type:"equipment", cost:1200, effects:{ speed:+2 }, social:+0, equipSlot:"feet", desc:"+2 Speed (equipped)" },
  { id:"gloves1", name:"Receiver Gloves", type:"equipment", cost:300, effects:{ agility:+1 }, social:+0, equipSlot:"hands", desc:"+1 Agility (equipped)" },
  { id:"gloves2", name:"Pro Gloves", type:"equipment", cost:1100, effects:{ agility:+2 }, social:+0, equipSlot:"hands", desc:"+2 Agility (equipped)" },
  { id:"brace1", name:"Compression Gear", type:"equipment", cost:250, effects:{ stamina:+1 }, social:+0, equipSlot:"body", desc:"+1 Stamina (equipped)" },
  { id:"brace2", name:"Recovery Kit", type:"equipment", cost:900, effects:{ stamina:+2 }, social:+0, equipSlot:"body", desc:"+2 Stamina (equipped)" },
  { id:"fit1", name:"Fresh Fit Outfit", type:"clothes", cost:220, effects:{}, social:+3, equipSlot:"style", desc:"+3 Social (equipped)" },
  { id:"fit2", name:"Designer Outfit", type:"clothes", cost:1300, effects:{}, social:+7, equipSlot:"style", desc:"+7 Social (equipped)" },
  { id:"watch1", name:"Nice Watch", type:"clothes", cost:600, effects:{}, social:+6, equipSlot:"style2", desc:"+6 Social (equipped)" },
  { id:"watch2", name:"Luxury Watch", type:"clothes", cost:5000, effects:{}, social:+12, equipSlot:"style2", desc:"+12 Social (equipped)" },
  { id:"tutor1", name:"Tutoring Sessions", type:"service", cost:180, effects:{}, social:+0, gradeBoost:+6, equipSlot:null, desc:"+6 Grades instantly" },
];

// Pro luxury purchases (no boosts)
const LUXURY_ITEMS = [
  { id:"car1", name:"Used Sports Car", cost:25000, desc:"Looks good. No stat boosts." },
  { id:"car2", name:"New Luxury Car", cost:120000, desc:"Flex value only." },
  { id:"house1", name:"Starter Home", cost:220000, desc:"Comfort upgrade only." },
  { id:"house2", name:"Mansion", cost:2500000, desc:"Big flex, no boosts." },
  { id:"jew1", name:"Gold Chain", cost:8000, desc:"No boosts." },
  { id:"jew2", name:"Diamond Set", cost:65000, desc:"No boosts." },
];

// NFL-style 32 teams: 2 conferences, 4 divisions each, 4 teams each
const NFL = (() => {
  const confs = ["AFC","NFC"];
  const divs = ["East","North","South","West"];
  const teams = [];
  let num = 1;
  for(const conf of confs){
    for(const div of divs){
      for(let i=0;i<4;i++){
        teams.push({
          id:`P${num}`,
          name:`${conf} ${div} Team ${i+1}`,
          conf, div,
          // "need" impacts free agency offers
          needs: pick(POSITIONS)
        });
        num++;
      }
    }
  }
  return { confs, divs, teams };
})();

/* ---------------- State ---------------- */
function makeNewCareer(){
  return {
    meta:{ version:"0.5", createdAt:Date.now() },
    ui:{ activeTab:"overview", logEl:null },
    phase:"BUILDER", // HS, COLLEGE, DRAFT, PRO
    week:1,
    year:1, // HS:1-4, College:1-4, Pro: seasons
    seasonWins:0,
    seasonLosses:0,
    player:null,

    life:{
      grades:70,
      social:50,
      fatigue:15,
      money:0, // displayed
    },

    hs:{
      teamName:"",
      schedule:[], // [{opp, oppOvr, isPlayoff, round}]
      recruit:{ rating:0, stars:1, rank:9999 },
      interest:[], // [{collegeId, interest, offered}]
      offers:[], // [collegeId]
      needs: null, // colleges needs are inside college objects; HS uses recruiting logic
      stats:{ games:0, yards:0, tds:0, ints:0, tackles:0, sacks:0 },
      playoff:null, // {bracket:[{team,ovr}],round:1,champion:null}
      otherRecruits:[], // competition
    },

    college:{
      collegeId:null,
      confId:null,
      money:0,
      inventory:[],
      equipped:{},
      declared:false,
      draftProjection:null, // {score, round, pick, text}
      schedule:[], // 12 games + conf champ + bowl/playoff
      standings:{}, // teamId -> {w,l,confW,confL}
      rankings:[], // weekly top 25 ids
      otherRecruitsCommitted:0,
      stats:{ games:0, yards:0, tds:0, ints:0, tackles:0, sacks:0 },
    },

    draft:{
      declared:false,
      invitedCombine:false,
      interviewsDone:false,
      result:null, // {teamId, round, pick} or null
    },

    pro:{
      teamId:null,
      rosterSpot:"Active", // Active / PracticeSquad
      money:0,
      seasonsPlayed:0,
      contract:{ yearsLeft:0, totalYears:0, annual:0, signedAtSeason:1 },
      schedule:[], // 18 weeks (17 games + bye) [{week, oppId, home, isBye}]
      league:null, // generated season state
      stats:{ games:0, yards:0, tds:0, ints:0, tackles:0, sacks:0 },
      purchases:[], // luxury purchases
      freeAgencyEligible:false,
      inFreeAgency:false,
      offers:[], // free agency offers
    }
  };
}

let state = makeNewCareer();

/* ---------------- Ratings ---------------- */
function getEffectiveRatings(){
  const base = {...state.player.ratings};
  const eq = state.college?.equipped || {};
  for(const slot of Object.keys(eq)){
    const itemId = eq[slot];
    const item = SHOP_ITEMS.find(i=>i.id===itemId);
    if(item?.effects){
      for(const [k,v] of Object.entries(item.effects)){
        base[k] = clamp(base[k] + v, 1, 99);
      }
    }
  }
  return base;
}

function calcOVR(){
  const p = state.player;
  const r = getEffectiveRatings();
  const avg = (...nums) => Math.round(nums.reduce((s,n)=>s+n,0)/nums.length);
  if(p.pos === "QB") return avg(r.awareness, r.speed, r.agility, r.stamina, r.strength);
  if(["RB","WR","CB"].includes(p.pos)) return avg(r.speed, r.agility, r.awareness, r.stamina, r.strength);
  if(["TE","LB","DL"].includes(p.pos)) return avg(r.strength, r.stamina, r.awareness, r.speed, r.agility);
  return avg(r.speed, r.strength, r.agility, r.awareness, r.stamina);
}

/* ---------------- Builder ---------------- */
let builder = { step:1, points:22, min:55, ratings:null, start:null, caps:null, archId:null };

function buildHeightOptions(){
  const sel = $("bHeight");
  const heights = [];
  for(let ft=5; ft<=7; ft++){
    for(let inch=0; inch<=11; inch++){
      if(ft===7 && inch>2) continue;
      heights.push(`${ft}'${inch}"`);
    }
  }
  sel.innerHTML = heights.map(h=>`<option value="${h}">${h}</option>`).join("");
  sel.value = `6'0"`;
}

function baseRatingsFromPhysical(pos, heightStr, weight, age){
  let speed=66, strength=66, agility=66, awareness=64, stamina=68;

  const [ftPart, inchPart] = heightStr.split("'");
  const ft = parseInt(ftPart,10);
  const inches = parseInt(inchPart.replace('"',''),10);
  const totalInches = ft*12 + inches;

  const w = clamp(weight, 150, 380);
  strength += Math.round((w - 200) / 14);
  speed -= Math.round((w - 200) / 22);
  agility -= Math.round((w - 200) / 24);

  strength += Math.round((totalInches - 70) / 7);
  agility -= Math.round((totalInches - 70) / 10);

  const a = clamp(age, 14, 18);
  if(a <= 15){ speed += 2; agility += 2; }
  if(a >= 17){ awareness += 2; stamina += 1; }

  if(pos === "QB"){ awareness += 4; stamina += 2; }
  if(pos === "RB"){ speed += 4; agility += 3; }
  if(pos === "WR"){ speed += 5; agility += 4; }
  if(pos === "TE"){ strength += 6; stamina += 3; }
  if(pos === "CB"){ speed += 5; agility += 5; }
  if(pos === "LB"){ strength += 7; awareness += 2; }
  if(pos === "DL"){ strength += 9; stamina += 2; speed -= 1; }

  return {
    speed: clamp(speed, 52, 78),
    strength: clamp(strength, 52, 80),
    agility: clamp(agility, 52, 80),
    awareness: clamp(awareness, 52, 80),
    stamina: clamp(stamina, 56, 82),
  };
}

function fillArchetypesForPos(pos){
  const list = ARCHETYPES[pos] || [];
  const sel = $("bArch");
  sel.innerHTML = list.map(a=>`<option value="${a.id}">${a.name}</option>`).join("");
  sel.value = list[0]?.id || "";
  builder.archId = sel.value;
}

function getArchetype(pos, archId){
  return (ARCHETYPES[pos]||[]).find(a=>a.id===archId) || (ARCHETYPES[pos]||[])[0];
}

function applyArchetype(pos){
  const arch = getArchetype(pos, builder.archId);
  if(!arch) return;
  builder.caps = arch.caps;
  for(const [k,v] of Object.entries(arch.boosts||{})){
    builder.ratings[k] = clamp(builder.ratings[k]+v, builder.min, builder.caps[k]);
  }
  $("capSpeed").textContent = `(cap ${builder.caps.speed})`;
  $("capStrength").textContent = `(cap ${builder.caps.strength})`;
  $("capAgility").textContent = `(cap ${builder.caps.agility})`;
  $("capAwareness").textContent = `(cap ${builder.caps.awareness})`;
  $("capStamina").textContent = `(cap ${builder.caps.stamina})`;
}

function pointsSpent(){
  let spent=0;
  for(const k of Object.keys(builder.ratings)){
    spent += Math.max(0, builder.ratings[k]-builder.start[k]);
  }
  return spent;
}
function pointsLeft(){ return clamp(builder.points - pointsSpent(), 0, builder.points); }

function renderBuilderRatings(pos){
  const r = builder.ratings;
  $("valSpeed").textContent = r.speed;
  $("valStrength").textContent = r.strength;
  $("valAgility").textContent = r.agility;
  $("valAwareness").textContent = r.awareness;
  $("valStamina").textContent = r.stamina;
  $("pointsLeft").textContent = pointsLeft();

  // temp player for preview ovr
  const temp = { pos, ratings:r };
  const r2 = {...r};
  const avg = (...nums) => Math.round(nums.reduce((s,n)=>s+n,0)/nums.length);
  let ovr = 0;
  if(pos === "QB") ovr = avg(r2.awareness, r2.speed, r2.agility, r2.stamina, r2.strength);
  else if(["RB","WR","CB"].includes(pos)) ovr = avg(r2.speed, r2.agility, r2.awareness, r2.stamina, r2.strength);
  else ovr = avg(r2.strength, r2.stamina, r2.awareness, r2.speed, r2.agility);
  $("ovrPreview").textContent = ovr;
}

function tryAdjustRating(attr, dir){
  const r = builder.ratings;
  const start = builder.start;
  const cap = builder.caps?.[attr] ?? 99;

  if(dir < 0){
    r[attr] = clamp(r[attr]-1, start[attr], cap);
    return;
  }
  if(pointsLeft() <= 0) return;
  r[attr] = clamp(r[attr]+1, builder.min, cap);
}

function setBuilderStep(n){
  builder.step = clamp(n,1,3);
  $("builderStep").textContent = builder.step;
  document.querySelectorAll(".builder-step").forEach(div=>{
    const step = parseInt(div.dataset.step,10);
    div.classList.toggle("hidden", step !== builder.step);
  });
  $("btnBack").textContent = builder.step === 1 ? "Cancel" : "Back";
  $("btnNext").textContent = builder.step === 3 ? "Start Career" : "Next";
}

function startBuilder(){
  showScreen("builder");
  setBuilderStep(1);
  buildHeightOptions();

  $("bName").value = "";
  $("bPos").value = "QB";
  $("bHand").value = "Right";
  $("bTown").value = "";
  $("bHSTeam").value = "";
  $("bHeight").value = `6'0"`;
  $("bWeight").value = 200;
  $("bAge").value = 15;

  fillArchetypesForPos("QB");
  const base = baseRatingsFromPhysical("QB", `6'0"`, 200, 15);
  builder.ratings = {...base};
  builder.start = {...base};
  builder.points = 22;
  builder.archId = $("bArch").value;
  applyArchetype("QB");
  renderBuilderRatings("QB");
}

function finalizeCareer(){
  const name = ($("bName").value||"").trim() || "Rookie";
  const pos = $("bPos").value;
  const hand = $("bHand").value;
  const hometown = ($("bTown").value||"").trim();
  const hsTeam = ($("bHSTeam").value||"").trim() || "Your High School";
  const height = $("bHeight").value;
  const weight = parseInt($("bWeight").value||"200",10);
  const age = parseInt($("bAge").value||"15",10);

  const arch = getArchetype(pos, builder.archId);

  state = makeNewCareer();
  state.phase = "HS";
  state.year = 1;
  state.week = 1;
  state.player = {
    id: (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())),
    name,pos,hand,hometown,height,weight,age,
    archetypeId: arch.id,
    archetypeName: arch.name,
    ratings:{...builder.ratings}
  };
  state.hs.teamName = hsTeam;

  state.life.grades = 72;
  state.life.social = 48;
  state.life.fatigue = 15;
  state.life.money = 0;

  // init systems
  initHSSeason();
  initRecruiting();
  initOtherRecruits();

  state.ui.activeTab = "overview";
  $("tabLogs").click(); // sets log element later
  $("tabOverview").click();
  $("tabSeason").classList.remove("ghost"); $("tabSeason").classList.add("ghost");
  $("tabRecruit").classList.remove("ghost"); $("tabRecruit").classList.add("ghost");

  logLine(`Started HS career for ${name} (${pos} - ${arch.name}).`);
  logLine(`High School Team: ${hsTeam}`);
  save();
  showScreen("career");
  renderCareer();
}

/* ---------------- HS Season + Playoffs ---------------- */
function initHSSeason(){
  state.hs.schedule = [];
  for(let w=1; w<=12; w++){
    state.hs.schedule.push({
      week:w,
      opp:`HS Opponent ${rnd(1,50)}`,
      oppOvr: clamp(rnd(50,80) + (state.year-1)*2, 45, 92),
      isPlayoff:false,
      round:null
    });
  }
  state.hs.playoff = null;
  state.seasonWins = 0;
  state.seasonLosses = 0;
  state.hs.stats = { games:0, yards:0, tds:0, ints:0, tackles:0, sacks:0 };
}

function qualifyHSPlayoffs(){
  return state.seasonWins >= 8;
}

function makeHSBracket(){
  // 8-team bracket: your team + 7 others
  const teams = [];
  teams.push({ name: state.hs.teamName, ovr: clamp(calcOVR() + rnd(-4,4), 55, 95), isUser:true });
  for(let i=0;i<7;i++){
    teams.push({ name:`State Team ${i+1}`, ovr: clamp(rnd(55,88) + (state.year-1)*2, 45, 95), isUser:false });
  }
  // seed by ovr
  teams.sort((a,b)=>b.ovr-a.ovr);
  state.hs.playoff = { round:1, teams, bracket:[], champion:null, userEliminated:false };
  logLine("HS Playoffs: Qualified! 8-team bracket begins.");
}

function simulateMatch(a,b,context){
  // win probability from ovr difference
  const diff = (a.ovr - b.ovr);
  const p = clamp(0.5 + diff*0.02, 0.15, 0.85);
  const winA = chance(p);
  const winner = winA ? a : b;
  const loser = winA ? b : a;
  if(context) logLine(`${context}: ${winner.name} defeats ${loser.name}`);
  return winner;
}

function playHSPlayoffRound(){
  const po = state.hs.playoff;
  if(!po || po.champion) return;

  const roundName = po.round === 1 ? "Quarterfinals" : po.round === 2 ? "Semifinals" : "State Championship";
  logLine(`--- HS Playoffs: ${roundName} ---`);

  // build matchups by seeding: 1v8,2v7,3v6,4v5
  const t = po.teams;
  let matchups = [];
  if(po.round === 1){
    matchups = [[t[0],t[7]],[t[1],t[6]],[t[2],t[5]],[t[3],t[4]]];
  } else {
    // use previous winners stored in bracket of last round
    const prev = po.bracket[po.bracket.length-1]?.winners || [];
    if(prev.length === 4) matchups = [[prev[0],prev[3]],[prev[1],prev[2]]];
    if(prev.length === 2) matchups = [[prev[0],prev[1]]];
  }

  const winners = matchups.map((m,i)=>simulateMatch(m[0],m[1], `${roundName} Game ${i+1}`));
  po.bracket.push({ round: po.round, matchups, winners });
  // check if user eliminated
  const userStill = winners.some(x=>x.isUser);
  if(!userStill){
    po.userEliminated = true;
    po.champion = winners[0]; // not accurate but fine for logging
    logLine("You were eliminated from the playoffs.");
    return;
  }
  if(winners.length === 1){
    po.champion = winners[0];
    logLine(`STATE CHAMPIONS: ${po.champion.name}!`);
  } else {
    po.round += 1;
  }
}

/* ---------------- Recruiting with needs + competition ---------------- */
function collegeNeedsForStars(stars){
  // positions needed in a class; higher stars fill fewer gaps
  const base = { QB:1, RB:1, WR:2, TE:1, CB:2, LB:2, DL:2 };
  // tweak by stars
  const factor = stars >= 4 ? 0.8 : stars === 3 ? 1.0 : 1.15;
  const needs = {};
  for(const p of POSITIONS){
    needs[p] = clamp(Math.round(base[p]*factor + rnd(-0,1)), 0, 4);
  }
  // ensure at least 1 skill position
  if(needs.WR === 0) needs.WR = 1;
  return needs;
}

function initRecruiting(){
  state.hs.interest = COLLEGES.map(c=>({
    collegeId:c.id,
    interest: rnd(0, 10),
    offered:false,
    // needs snapshot per college
    needs: collegeNeedsForStars(c.stars),
    filled: Object.fromEntries(POSITIONS.map(p=>[p,0])),
  }));
  state.hs.offers = [];
}

function initOtherRecruits(){
  // Create 220 other recruits; they commit over time and fill needs
  const recruits = [];
  for(let i=0;i<220;i++){
    const pos = pick(POSITIONS);
    // rating distribution
    const rating = clamp(Math.round(rnd(55, 95) + rnd(-6,6)), 45, 98);
    let stars = 1;
    if(rating >= 92) stars = 5;
    else if(rating >= 84) stars = 4;
    else if(rating >= 76) stars = 3;
    else if(rating >= 68) stars = 2;
    const rank = clamp(Math.round(6000 - rating*55 + rnd(-300,300)), 1, 5000);
    recruits.push({ id:`R${i+1}`, pos, rating, stars, rank, committed:null });
  }
  recruits.sort((a,b)=>a.rank-b.rank);
  state.hs.otherRecruits = recruits;
}

function updateRecruitProfile(){
  const ovr = calcOVR();
  const s = state.hs.stats;
  const production = s.games ? (s.tds*12 + s.yards/25 + s.tackles*3 + s.sacks*6 - s.ints*8) / s.games : 0;
  const academics = (state.life.grades - 50) * 0.6;
  const social = (state.life.social - 50) * 0.15;
  const score = ovr + production + academics + social + rnd(-5, 6);

  const rating = clamp(Math.round(score), 40, 99);
  let stars = 1;
  if(rating >= 92) stars = 5;
  else if(rating >= 84) stars = 4;
  else if(rating >= 76) stars = 3;
  else if(rating >= 68) stars = 2;

  const rank = clamp(Math.round(6000 - rating * 55 + rnd(-250,250)), 1, 5000);
  state.hs.recruit = { rating, stars, rank };
}

function interestGate(college, recruitStars, recruitRating){
  // better colleges only recruit if you're performing well
  const gate = 58 + college.stars*6; // 1★ ~64, 5★ ~88
  const starGate = college.stars - 1; // 5★ prefers 4★+
  return (recruitRating >= gate) && (recruitStars >= clamp(starGate,1,5));
}

function bumpRecruiting(amount){
  const prof = state.hs.recruit;
  const pos = state.player.pos;

  for(const row of state.hs.interest){
    const c = COLLEGES.find(x=>x.id===row.collegeId);
    if(!c) continue;

    // if position need filled, interest slows/halts
    const need = row.needs[pos] ?? 0;
    const filled = row.filled[pos] ?? 0;
    if(need > 0 && filled >= need){
      // position full
      row.interest = clamp(row.interest + rnd(0,1), 0, 100);
      continue;
    }

    const eligible = interestGate(c, prof.stars, prof.rating);
    if(eligible){
      row.interest = clamp(row.interest + rnd(1, amount), 0, 100);
    } else {
      row.interest = clamp(row.interest + rnd(0, Math.max(1, Math.floor(amount/3))), 0, 100);
    }
  }

  // Offer thresholds + needs gating
  for(const row of state.hs.interest){
    if(row.offered) continue;
    const c = COLLEGES.find(x=>x.id===row.collegeId);
    if(!c) continue;

    const pos = state.player.pos;
    const need = row.needs[pos] ?? 0;
    const filled = row.filled[pos] ?? 0;
    if(need > 0 && filled >= need) continue; // no offer if slot full

    const offerAt = 35 + c.stars * 8; // 1★ ~43, 5★ ~75
    if(row.interest >= offerAt){
      row.offered = true;
      state.hs.offers.push(row.collegeId);
      logLine(`Offer Received: ${c.name} (${c.stars}⭐)`);
    }
  }
}

function progressOtherRecruitsCommitments(){
  // each week a handful of recruits commit and fill needs by position
  const open = state.hs.otherRecruits.filter(r=>!r.committed);
  const commitsThisWeek = rnd(3, 10);
  for(let i=0;i<commitsThisWeek && open.length;i++){
    // pick a top-ish recruit (bias toward higher rank)
    const r = open.splice(rnd(0, Math.min(open.length-1, 35)), 1)[0];
    if(!r) continue;

    // choose a college: star match + available need at that position
    const candidates = state.hs.interest
      .map(row=>{
        const c = COLLEGES.find(x=>x.id===row.collegeId);
        if(!c) return null;
        const need = row.needs[r.pos] ?? 0;
        const filled = row.filled[r.pos] ?? 0;
        if(need > 0 && filled >= need) return null;
        // score: prestige + star closeness + interest baseline
        const starFit = 1 - Math.abs(c.stars - r.stars)*0.22;
        const prestigeFit = (c.prestige/100)*0.6;
        const score = starFit + prestigeFit + (row.interest/100)*0.35 + rnd(-10,10)*0.01;
        return { row, c, score };
      })
      .filter(Boolean)
      .sort((a,b)=>b.score-a.score)
      .slice(0, 8);

    const choice = candidates.length ? pick(candidates.slice(0,3)) : null;
    if(choice){
      r.committed = choice.c.id;
      // fill the position
      choice.row.filled[r.pos] = (choice.row.filled[r.pos]||0) + 1;
      // if college was recruiting you at same position and got filled, it may cool
      if(r.pos === state.player.pos){
        // small negative effect if a slot got filled by another recruit
        choice.row.interest = clamp(choice.row.interest - rnd(0,4), 0, 100);
      }
    } else {
      // no candidate found; commit to a random low-tier
      const fallback = COLLEGES.filter(c=>c.stars<=2);
      r.committed = pick(fallback).id;
    }
  }
}

/* ---------------- Weekly Actions ---------------- */
function doTrain(){
  const r = state.player.ratings;
  const gainKey = pick(["speed","strength","agility","stamina"]);
  r[gainKey] = clamp(r[gainKey] + 1, 1, 99);
  state.life.fatigue = clamp(state.life.fatigue + 9, 0, 100);
  state.life.grades = clamp(state.life.grades - 1, 0, 100);
  logLine(`Training: +1 ${gainKey.toUpperCase()} (fatigue +9, grades -1)`);
}
function doStudy(){
  state.life.grades = clamp(state.life.grades + 7, 0, 100);
  state.life.social = clamp(state.life.social - 2, 0, 100);
  state.life.fatigue = clamp(state.life.fatigue + 2, 0, 100);
  state.player.ratings.awareness = clamp(state.player.ratings.awareness + (rnd(0,1)), 1, 99);
  logLine("Study: grades +7 (social -2, fatigue +2)");
}
function doSocial(){
  state.life.social = clamp(state.life.social + 7, 0, 100);
  state.life.grades = clamp(state.life.grades - 2, 0, 100);
  state.life.fatigue = clamp(state.life.fatigue + 2, 0, 100);
  logLine("Social: social +7 (grades -2, fatigue +2)");
}
function doWork(){
  if(state.phase === "HS"){
    // HS: small allowance
    const cash = 25 + rnd(-5,10);
    state.life.money += cash;
    state.life.fatigue = clamp(state.life.fatigue + 3, 0, 100);
    logLine(`Work: earned ${fmtMoney(cash)} (HS allowance)`);
    return;
  }
  if(state.phase === "COLLEGE"){
    const wage = 55 + rnd(-10,10);
    state.college.money += wage;
    state.life.money = state.college.money;
    state.life.fatigue = clamp(state.life.fatigue + 4, 0, 100);
    state.life.social = clamp(state.life.social - 1, 0, 100);
    logLine(`Work: earned ${fmtMoney(wage)} (fatigue +4, social -1)`);
    return;
  }
  if(state.phase === "PRO"){
    logLine("Work: Not needed — you're a pro. Use Contracts/Shop to manage money.");
  }
}

/* ---------------- Simulate a Game ---------------- */
function simulatePlayerGame(level, opponentOvr){
  const p = state.player;
  const r = getEffectiveRatings();
  const fatiguePenalty = Math.round(state.life.fatigue * 0.25);
  const disciplineBonus = Math.round((state.life.grades - 60) * 0.08);
  const socialSwing = Math.round((state.life.social - 50) * 0.04);

  const ovr = calcOVR();
  const effective = clamp(ovr - fatiguePenalty + disciplineBonus + socialSwing, 1, 99);

  const opp = clamp(opponentOvr ?? (level==="HS" ? rnd(50,80) : level==="COLLEGE" ? rnd(55,88) : rnd(70,92)), 45, 96);
  const diff = effective - opp;
  const win = diff + rnd(-12, 12) >= 0;

  // choose stats bucket based on phase
  const stats = (level==="HS") ? state.hs.stats : (level==="COLLEGE" ? state.college.stats : state.pro.stats);

  if(p.pos === "QB"){
    const yards = clamp(rnd(120, 420) + diff * 6, 50, 560);
    const tds = clamp(rnd(0, 5) + Math.floor(diff/18), 0, 7);
    const ints = clamp(rnd(0, 3) - Math.floor(diff/22), 0, 5);
    stats.yards += yards; stats.tds += tds; stats.ints += ints;
    logLine(`Game: ${win ? "WIN" : "LOSS"} vs OVR ${opp} • QB: ${yards} yds, ${tds} TD, ${ints} INT`);
  } else if(["RB","WR","TE"].includes(p.pos)){
    const yards = clamp(rnd(30, 220) + diff * 3, 5, 320);
    const tds = clamp(rnd(0, 3) + Math.floor(diff/22), 0, 5);
    stats.yards += yards; stats.tds += tds;
    logLine(`Game: ${win ? "WIN" : "LOSS"} vs OVR ${opp} • Offense: ${yards} yds, ${tds} TD`);
  } else {
    const tackles = clamp(rnd(2, 14) + Math.floor(diff/10), 0, 24);
    const sacks = clamp(rnd(0, 3) + Math.floor(diff/28), 0, 6);
    stats.tackles += tackles; stats.sacks += sacks;
    logLine(`Game: ${win ? "WIN" : "LOSS"} vs OVR ${opp} • Defense: ${tackles} tackles, ${sacks} sacks`);
  }

  stats.games += 1;

  // fatigue from game
  state.life.fatigue = clamp(state.life.fatigue + (level==="PRO" ? 10 : 8), 0, 100);

  // postgame interview
  const impact = diff + rnd(-10,10) + (p.pos==="QB" ? rnd(0,5) : 0);
  if(impact >= 18){
    logLine("Postgame Interview: You made a big impact (+social, +stock).");
    state.life.social = clamp(state.life.social + 4, 0, 100);
    if(state.phase === "HS") bumpRecruiting(6);
    if(state.phase === "COLLEGE") bumpDraftStock(3);
    if(state.phase === "PRO") {
      // small brand money
      const bonus = 1500 + rnd(-400,1200);
      state.pro.money += bonus;
      state.life.money = state.pro.money;
      logLine(`Brand Bonus: earned ${fmtMoney(bonus)} from exposure.`);
    }
  }

  return win;
}

/* ---------------- HS weekly progression ---------------- */
function hsWeekProgression(){
  state.life.grades = clamp(state.life.grades - 1, 0, 100);
  state.life.social = clamp(state.life.social - 1, 0, 100);
  state.life.fatigue = clamp(state.life.fatigue - 3, 0, 100);

  if(state.life.grades < 50){
    state.player.ratings.awareness = clamp(state.player.ratings.awareness - 1, 1, 99);
    logLine("Grades Warning: struggling in class (-1 Awareness).");
  }

  updateRecruitProfile();
  progressOtherRecruitsCommitments();
  bumpRecruiting(4);
}

/* ---------------- College schedule/standings/rankings ---------------- */
function initCollegeSeason(){
  state.college.schedule = [];
  state.seasonWins = 0;
  state.seasonLosses = 0;
  state.college.stats = { games:0, yards:0, tds:0, ints:0, tackles:0, sacks:0 };

  // standings for all college teams (simulated)
  state.college.standings = {};
  for(const c of COLLEGES){
    state.college.standings[c.id] = { w:0, l:0, confW:0, confL:0 };
  }

  // Build 12-game schedule: 8 conference games + 4 nonconf
  const myId = state.college.collegeId;
  const my = COLLEGES.find(x=>x.id===myId);
  const confTeams = COLLEGES.filter(c=>c.confId===my.confId && c.id!==myId);
  const nonConf = COLLEGES.filter(c=>c.confId!==my.confId);

  const confOpp = shuffle(confTeams).slice(0,8);
  const nonOpp = shuffle(nonConf).slice(0,4);
  let week=1;
  for(const opp of [...confOpp, ...nonOpp]){
    state.college.schedule.push({
      week,
      oppId: opp.id,
      oppName: opp.name,
      oppOvr: clamp(Math.round(48 + opp.stars*10 + rnd(-4,4)), 45, 95),
      confGame: opp.confId===my.confId
    });
    week++;
  }
  // sort by week (already)
  state.college.schedule.sort((a,b)=>a.week-b.week);

  // rankings initial
  computeCollegeRankings();
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function computeCollegeRankings(){
  // ranking score = prestige + record*6 + recent form random
  const scores = COLLEGES.map(c=>{
    const st = state.college.standings[c.id] || {w:0,l:0,confW:0,confL:0};
    const rec = st.w - st.l;
    const score = (c.prestige) + rec*6 + rnd(-6,6);
    return { id:c.id, score };
  }).sort((a,b)=>b.score-a.score);

  state.college.rankings = scores.slice(0,25).map(x=>x.id);
}

function simulateOtherCollegeWeek(week){
  // simulate games for all teams with simple matchup sampling
  // Not a full schedule; just evolve standings plausibly.
  for(const c of COLLEGES){
    if(c.id === state.college.collegeId) continue;
    // chance of playing this week (during weeks 1-12)
    if(week>=1 && week<=12){
      const st = state.college.standings[c.id];
      const opp = pick(COLLEGES.filter(x=>x.id!==c.id));
      const myO = clamp(50 + c.stars*10 + rnd(-6,6), 45, 95);
      const opO = clamp(50 + opp.stars*10 + rnd(-6,6), 45, 95);
      const win = (myO - opO) + rnd(-12,12) >= 0;
      if(win) st.w++; else st.l++;
      if(opp.confId === c.confId){ if(win) st.confW++; else st.confL++; }
    }
  }
}

function collegeWeekProgression(){
  state.life.grades = clamp(state.life.grades - 2, 0, 100);
  state.life.social = clamp(state.life.social - 1, 0, 100);
  state.life.fatigue = clamp(state.life.fatigue - 2, 0, 100);

  if(state.life.grades < 50){
    state.player.ratings.awareness = clamp(state.player.ratings.awareness - 1, 1, 99);
    logLine("Academic Trouble: GPA slipping (-1 Awareness).");
  }

  ensureProjectionIfJunior();
  if(state.college.draftProjection){
    // update projection weekly
    const ovr = calcOVR();
    const s = state.college.stats;
    const prod = s.games ? (s.tds*12 + s.yards/25 + s.tackles*3 + s.sacks*6 - s.ints*8) / s.games : 0;
    const g = (state.life.grades - 60) * 0.35;
    let delta = Math.round((ovr-70)*0.03 + prod*0.06 + g*0.03 + rnd(-2,2));
    state.college.draftProjection.score = clamp(state.college.draftProjection.score + delta, 0, 100);
    state.college.draftProjection = computeProjection(state.college.draftProjection.score);
  }
}

/* ---------------- Draft projection ---------------- */
function bumpDraftStock(amount){
  if(!state.college.draftProjection) return;
  state.college.draftProjection.score = clamp(state.college.draftProjection.score + amount, 0, 100);
  state.college.draftProjection = computeProjection(state.college.draftProjection.score);
}

function computeProjection(score){
  let text = "Undrafted";
  let round = null;
  let pickNum = null;

  if(score >= 92){ round=1; pickNum=rnd(1,10); text=`Round 1 (Top 10)`; }
  else if(score >= 86){ round=1; pickNum=rnd(11,32); text=`Round 1`; }
  else if(score >= 78){ round=2; pickNum=rnd(33,64); text=`Round 2`; }
  else if(score >= 72){ round=3; pickNum=rnd(65,96); text=`Round 3`; }
  else if(score >= 64){ round=4; pickNum=rnd(97,128); text=`Round 4`; }
  else if(score >= 56){ round=5; pickNum=rnd(129,160); text=`Round 5`; }
  else if(score >= 48){ round=6; pickNum=rnd(161,192); text=`Round 6`; }
  else if(score >= 45){ round=7; pickNum=rnd(193,224); text=`Round 7`; }
  else { text = "Undrafted (fringe)"; }

  return { score, round, pick: pickNum, text };
}

function ensureProjectionIfJunior(){
  if(state.phase !== "COLLEGE") return;
  if(state.year < 3) return;
  if(state.college.draftProjection) return;

  const ovr = calcOVR();
  const s = state.college.stats;
  const prod = s.games ? (s.tds*12 + s.yards/25 + s.tackles*3 + s.sacks*6 - s.ints*8) / s.games : 0;
  const g = (state.life.grades - 60) * 0.5;
  const college = COLLEGES.find(c=>c.id===state.college.collegeId);
  const prestige = ((college?.prestige || 60) - 60) * 0.12;

  let score = clamp(Math.round(ovr + prod + g + prestige + rnd(-6,6)), 0, 100);
  state.college.draftProjection = computeProjection(score);
  logLine(`Draft Projection starts: ${state.college.draftProjection.text} (score ${state.college.draftProjection.score})`);
}

function canDeclare(){
  return state.phase === "COLLEGE" && state.year >= 3 && !state.college.declared;
}

function declareForDraft(){
  if(!canDeclare()){
    logLine("You can declare starting Junior year.");
    return;
  }
  state.college.declared = true;
  state.draft.declared = true;

  const proj = state.college.draftProjection || computeProjection(40);
  const invite = (proj.score >= 60) || (calcOVR() >= 78);
  state.draft.invitedCombine = invite;

  logLine("Declared for the Pro Draft.");
  logLine(invite ? "Combine Invite: YES" : "Combine Invite: NO (you may go undrafted)");
}

function runInterviews(){
  const teams = NFL.teams.slice().sort(()=>Math.random()-0.5).slice(0,3);
  logLine("Pre-Draft Interviews (Top 3 likely teams):");
  for(const t of teams){
    const perf = rnd(-2,4) + Math.round((state.life.grades-60)*0.05);
    logLine(`• ${t.name}: interview ${perf>=2?"great":perf>=0?"ok":"rough"} (${perf>=0?"+":""}${perf} projection)`);
    if(state.college.draftProjection){
      state.college.draftProjection.score = clamp(state.college.draftProjection.score + perf, 0, 100);
      state.college.draftProjection = computeProjection(state.college.draftProjection.score);
    }
  }
  state.draft.interviewsDone = true;
}

function runCombine(){
  if(!state.draft.invitedCombine) return;
  const r = getEffectiveRatings();
  const forty = clamp(4.95 - (r.speed-60)*0.01 + (state.player.weight-200)*0.0006 + rnd(-5,5)*0.01, 4.25, 5.20);
  const bench = clamp(Math.round((r.strength-55)*0.6 + rnd(0,6)), 8, 40);
  const shuttle = clamp(4.65 - (r.agility-60)*0.012 + rnd(-6,6)*0.01, 3.85, 4.95);
  logLine(`Combine: 40yd ${forty.toFixed(2)}s • Bench ${bench} • Shuttle ${shuttle.toFixed(2)}s`);

  let delta = 0;
  if(forty <= 4.50) delta += 4;
  else if(forty <= 4.62) delta += 2;
  else if(forty >= 4.85) delta -= 2;
  if(bench >= 24) delta += 2;
  else if(bench <= 12) delta -= 2;
  if(shuttle <= 4.20) delta += 2;
  else if(shuttle >= 4.55) delta -= 1;

  if(state.college.draftProjection){
    state.college.draftProjection.score = clamp(state.college.draftProjection.score + delta, 0, 100);
    state.college.draftProjection = computeProjection(state.college.draftProjection.score);
  }
  logLine(`Combine Impact: ${delta>=0?"+":""}${delta} projection score`);
}

function estimateRookieSalary(round, pickNum, pos){
  // Rough realistic annual salary estimates
  const posMult = (pos==="QB") ? 1.25 : (pos==="WR"||pos==="RB") ? 1.1 : 1.0;
  let base = 800000; // minimum-ish
  if(round === 1 && pickNum <= 10) base = 8500000;
  else if(round === 1) base = 4200000;
  else if(round === 2) base = 2100000;
  else if(round === 3) base = 1450000;
  else if(round === 4) base = 1100000;
  else if(round === 5) base = 980000;
  else if(round === 6) base = 920000;
  else if(round === 7) base = 870000;
  return Math.round((base + rnd(-200000, 500000)) * posMult);
}

function runDraft(){
  if(!state.college.draftProjection){
    state.college.draftProjection = computeProjection(clamp(calcOVR() - 15, 0, 100));
  }
  logLine("--- Draft Process Begins ---");
  if(state.draft.declared){
    if(state.draft.invitedCombine) runCombine();
    runInterviews();
  }

  const proj = state.college.draftProjection;
  logLine(`Final Projection: ${proj.text} (score ${proj.score})`);

  const score = proj.score;
  const draftedChance = clamp((score - 40) / 60, 0, 1);
  const drafted = chance(draftedChance);

  if(!drafted){
    state.draft.result = null;
    logLine("Draft Result: UNDRAFTED");
    // sign as UDFA (practice squad)
    const team = pick(NFL.teams);
    state.phase = "PRO";
    initProCareer(team.id, null, null, true);
    return;
  }

  const round = proj.round ?? rnd(5,7);
  const pickNum = proj.pick ?? rnd(200,224);
  const team = pick(NFL.teams);

  state.draft.result = { teamId:team.id, round, pick:pickNum };
  state.phase = "PRO";
  initProCareer(team.id, round, pickNum, false);
}

/* ---------------- College postseason: bowls + playoff ---------------- */
function getCollegeRec(id){
  const st = state.college.standings[id] || {w:0,l:0,confW:0,confL:0};
  return `${st.w}-${st.l}`;
}

function playCollegeConfChampionship(){
  // top 2 teams by conf record in your conference play
  const my = COLLEGES.find(c=>c.id===state.college.collegeId);
  const teams = COLLEGES.filter(c=>c.confId===my.confId);
  teams.sort((a,b)=>{
    const sa = state.college.standings[a.id];
    const sb = state.college.standings[b.id];
    const aKey = (sa.confW-sa.confL)*10 + (sa.w-sa.l) + a.prestige/100;
    const bKey = (sb.confW-sb.confL)*10 + (sb.w-sb.l) + b.prestige/100;
    return bKey - aKey;
  });

  const a = teams[0], b = teams[1];
  logLine(`Conference Championship: ${a.name} vs ${b.name}`);
  // if user college involved, simulate player game effect; otherwise quick sim
  const userIn = (a.id===my.id || b.id===my.id);
  let winner;
  if(userIn){
    const opp = (a.id===my.id) ? b : a;
    const win = simulatePlayerGame("COLLEGE", clamp(50+opp.stars*10+rnd(-4,4),45,95));
    winner = win ? my : opp;
    // update standings
    const stMy = state.college.standings[my.id];
    const stOpp = state.college.standings[opp.id];
    if(win){ stMy.w++; stMy.confW++; stOpp.l++; stOpp.confL++; }
    else { stMy.l++; stMy.confL++; stOpp.w++; stOpp.confW++; }
  } else {
    const oa = clamp(50+a.stars*10+rnd(-4,4),45,95);
    const ob = clamp(50+b.stars*10+rnd(-4,4),45,95);
    winner = (oa-ob)+rnd(-12,12)>=0 ? a : b;
    const stW = state.college.standings[winner.id];
    const loser = winner.id===a.id ? b : a;
    const stL = state.college.standings[loser.id];
    stW.w++; stW.confW++;
    stL.l++; stL.confL++;
  }
  logLine(`Conference Champion: ${winner.name}`);
  computeCollegeRankings();
}

function selectCollegePlayoffAndBowls(){
  // 4-team playoff: top 4 in rankings. Bowls for next best.
  computeCollegeRankings();
  const top25 = state.college.rankings.slice();
  const playoff = top25.slice(0,4);
  const bowls = top25.slice(4,16); // 12 teams -> 6 bowls
  return { playoff, bowls };
}

function playCollegePostseason(){
  logLine("--- College Postseason ---");
  const { playoff, bowls } = selectCollegePlayoffAndBowls();

  const idToName = (id)=>COLLEGES.find(c=>c.id===id)?.name || id;

  logLine(`College Playoff: 1) ${idToName(playoff[0])}  2) ${idToName(playoff[1])}  3) ${idToName(playoff[2])}  4) ${idToName(playoff[3])}`);

  // Bowls (quick sim, unless user involved)
  for(let i=0;i<bowls.length;i+=2){
    const a = bowls[i], b = bowls[i+1];
    if(!b) break;
    const userIn = (a===state.college.collegeId || b===state.college.collegeId);
    if(userIn){
      const oppId = (a===state.college.collegeId) ? b : a;
      logLine(`Bowl Game: ${idToName(state.college.collegeId)} vs ${idToName(oppId)}`);
      const opp = COLLEGES.find(c=>c.id===oppId);
      const win = simulatePlayerGame("COLLEGE", clamp(50+opp.stars*10+rnd(-4,4),45,95));
      const stMy = state.college.standings[state.college.collegeId];
      const stOpp = state.college.standings[oppId];
      if(win) stMy.w++; else stMy.l++;
      if(win) logLine("Bowl Result: WIN"); else logLine("Bowl Result: LOSS");
    } else {
      logLine(`Bowl: ${idToName(a)} vs ${idToName(b)} (sim)`);
    }
  }

  // Playoff semifinals then championship
  function simTeam(id){
    const c = COLLEGES.find(x=>x.id===id);
    const st = state.college.standings[id];
    const score = (c.prestige) + (st.w-st.l)*6 + rnd(-8,8);
    return score;
  }
  function playoffGame(a,b,tag){
    const userIn = (a===state.college.collegeId || b===state.college.collegeId);
    if(userIn){
      const oppId = (a===state.college.collegeId) ? b : a;
      logLine(`${tag}: ${idToName(state.college.collegeId)} vs ${idToName(oppId)}`);
      const opp = COLLEGES.find(c=>c.id===oppId);
      const win = simulatePlayerGame("COLLEGE", clamp(52+opp.stars*10+rnd(-4,4),45,96));
      return win ? state.college.collegeId : oppId;
    }
    const winA = simTeam(a) - simTeam(b) + rnd(-10,10) >= 0;
    return winA ? a : b;
  }

  const semi1 = playoffGame(playoff[0], playoff[3], "Semifinal 1");
  const semi2 = playoffGame(playoff[1], playoff[2], "Semifinal 2");
  const champ = playoffGame(semi1, semi2, "National Championship");
  logLine(`NATIONAL CHAMPIONS: ${idToName(champ)}!`);
}

/* ---------------- Enter College ---------------- */
function enterCollege(collegeId){
  state.phase = "COLLEGE";
  state.college.collegeId = collegeId;
  const c = COLLEGES.find(x=>x.id===collegeId);
  state.college.confId = c?.confId || null;

  state.year = 1;
  state.week = 1;
  state.life.fatigue = 18;
  state.life.grades = clamp(state.life.grades + 6, 0, 100);
  state.life.social = clamp(state.life.social + 3, 0, 100);

  state.college.money = Math.max(0, state.college.money || 0);
  state.life.money = state.college.money;

  // carry HS money into college
  state.college.money += (state.life.money || 0);
  state.life.money = state.college.money;

  // ensure inventory/equipped exist
  state.college.inventory = state.college.inventory || [];
  state.college.equipped = state.college.equipped || {};

  logLine(`Enrolled at ${c?.name || "College"} (${c?.stars || "?"}⭐)`);
  initCollegeSeason();
  save();
  renderCareer();
}

/* ---------------- Shop / Inventory ---------------- */
function getOwnedItem(itemId){
  return (state.college.inventory || []).find(x=>x.itemId===itemId);
}
function buyItem(itemId){
  // Gear available in college and pro (boosts apply), but uses phase money pools
  const item = SHOP_ITEMS.find(i=>i.id===itemId);
  if(!item) return;

  const wallet = (state.phase==="PRO") ? state.pro.money : (state.phase==="COLLEGE") ? state.college.money : state.life.money;
  if(wallet < item.cost){
    logLine("Not enough money.");
    return;
  }
  if(state.phase==="PRO") state.pro.money -= item.cost;
  else if(state.phase==="COLLEGE") state.college.money -= item.cost;
  else state.life.money -= item.cost;

  state.life.money = (state.phase==="PRO") ? state.pro.money : (state.phase==="COLLEGE") ? state.college.money : state.life.money;

  if(item.type === "service" && item.gradeBoost){
    state.life.grades = clamp(state.life.grades + item.gradeBoost, 0, 100);
    logLine(`Purchased: ${item.name} (${fmtMoney(item.cost)}) • grades +${item.gradeBoost}`);
    return;
  }

  if(!getOwnedItem(itemId)){
    state.college.inventory.push({itemId});
  }
  logLine(`Purchased: ${item.name} (${fmtMoney(item.cost)})`);
}

function toggleEquip(itemId){
  const item = SHOP_ITEMS.find(i=>i.id===itemId);
  if(!item || !item.equipSlot) return;
  if(!getOwnedItem(itemId)) return;

  const slot = item.equipSlot;
  if(state.college.equipped[slot] === itemId){
    delete state.college.equipped[slot];
    logLine(`Unequipped: ${item.name}`);
  }else{
    state.college.equipped[slot] = itemId;
    logLine(`Equipped: ${item.name}`);
    if(item.social){
      state.life.social = clamp(state.life.social + item.social, 0, 100);
    }
  }
}

function buyLuxury(itemId){
  if(state.phase !== "PRO") return;
  const item = LUXURY_ITEMS.find(i=>i.id===itemId);
  if(!item) return;
  if(state.pro.money < item.cost){ logLine("Not enough pro money."); return; }
  state.pro.money -= item.cost;
  state.life.money = state.pro.money;
  state.pro.purchases.push(itemId);
  logLine(`Purchased luxury: ${item.name} (${fmtMoney(item.cost)})`);
}

/* ---------------- Pro League: schedule + season + playoffs ---------------- */
function initProCareer(teamId, round, pickNum, isUDFA){
  state.pro.teamId = teamId;
  state.pro.money = state.pro.money || 0;
  state.life.money = state.pro.money;

  // contract
  if(isUDFA){
    const annual = 780000;
    state.pro.contract = { yearsLeft:1, totalYears:1, annual, signedAtSeason:1 };
    state.pro.rosterSpot = "PracticeSquad";
    logLine(`Signed as UDFA with ${getProTeam(teamId).name} • ${fmtMoney(annual)}/yr (practice squad).`);
  } else {
    const annual = estimateRookieSalary(round, pickNum, state.player.pos);
    const totalYears = 4; // simplified
    state.pro.contract = { yearsLeft: totalYears, totalYears, annual, signedAtSeason:1 };
    state.pro.rosterSpot = "Active";
    logLine(`Drafted by ${getProTeam(teamId).name} • Rookie deal ${fmtMoney(annual)}/yr for ${totalYears} years.`);
  }

  // start pro season
  state.pro.seasonsPlayed = 0;
  state.pro.freeAgencyEligible = false;
  state.pro.inFreeAgency = false;
  state.pro.offers = [];
  startNewProSeason();
}

function getProTeam(id){ return NFL.teams.find(t=>t.id===id); }

function rotationIndexForSeason(season){ return (season-1) % 4; }

function getDivisionTeams(conf, div){
  return NFL.teams.filter(t=>t.conf===conf && t.div===div);
}
function getConferenceTeams(conf){
  return NFL.teams.filter(t=>t.conf===conf);
}

function buildNFLScheduleForTeam(teamId, seasonNumber){
  // NFL-ish 17 game schedule:
  // 6 division games (home/away)
  // 4 games vs a rotating in-conference division
  // 4 games vs a rotating inter-conference division
  // 2 games vs same-place teams in remaining in-conference divisions
  // 1 game vs inter-conference same-place team (extra 17th)
  // We'll approximate "same-place" with last season standings if available; else random.
  const team = getProTeam(teamId);
  const conf = team.conf;
  const div = team.div;

  const divTeams = getDivisionTeams(conf, div).filter(t=>t.id!==teamId);
  const confDivs = NFL.divs.slice();
  const otherConf = (conf==="AFC") ? "NFC" : "AFC";

  const divIdx = confDivs.indexOf(div);
  const inConfOppDiv = confDivs[(divIdx + 1 + rotationIndexForSeason(seasonNumber)) % 4];
  const interOppDiv = confDivs[(divIdx + 2 + rotationIndexForSeason(seasonNumber)) % 4];

  const inConfDivTeams = getDivisionTeams(conf, inConfOppDiv);
  const interDivTeams = getDivisionTeams(otherConf, interOppDiv);

  const games = [];

  // 6 division games (2 each)
  for(const t of divTeams){
    games.push({ oppId:t.id, home:true, tag:"DIV" });
    games.push({ oppId:t.id, home:false, tag:"DIV" });
  }

  // 4 in-conference division (one each)
  for(const t of inConfDivTeams){
    games.push({ oppId:t.id, home: chance(0.5), tag:"CONF" });
  }

  // 4 inter-conference division
  for(const t of interDivTeams){
    games.push({ oppId:t.id, home: chance(0.5), tag:"XCONF" });
  }

  // Same-place (approx): pick 2 teams from remaining two divisions in conference
  const remainingDivs = confDivs.filter(d=>d!==div && d!==inConfOppDiv);
  const candidatesSame = remainingDivs.flatMap(d=>getDivisionTeams(conf, d));
  const same2 = shuffle(candidatesSame).slice(0,2);
  for(const t of same2){
    games.push({ oppId:t.id, home: chance(0.5), tag:"SAME" });
  }

  // extra 17th game: inter-conf same-place (approx random from other conf remaining division)
  const otherCandidates = getConferenceTeams(otherConf);
  const extra = pick(otherCandidates);
  games.push({ oppId: extra.id, home: chance(0.5), tag:"EXTRA" });

  // Should be 17. Add/trim as needed (safety)
  while(games.length < 17){
    const t = pick(getConferenceTeams(conf).filter(x=>x.id!==teamId));
    games.push({ oppId:t.id, home: chance(0.5), tag:"FILL" });
  }
  if(games.length > 17) games.length = 17;

  // Add bye week, expand to 18 weeks
  const weeks = Array.from({length:18}, (_,i)=>i+1);
  const byeWeek = pick(weeks.slice(5,13)); // week 6-13
  const schedule = [];
  let gi = 0;
  for(const w of weeks){
    if(w === byeWeek){
      schedule.push({ week:w, isBye:true });
    } else {
      const g = games[gi++];
      schedule.push({ week:w, isBye:false, oppId:g.oppId, home:g.home, tag:g.tag });
    }
  }
  return schedule;
}

function buildLeagueSeason(seasonNumber){
  // Create league state: records, schedules for all teams
  const league = {
    seasonNumber,
    week:1,
    records: {}, // teamId -> {w,l, pf, pa, divW,divL, confW,confL}
    schedules: {}, // teamId -> schedule
    resultsByWeek: {}, // week -> list
    playoffs: null,
    champ: null
  };

  for(const t of NFL.teams){
    league.records[t.id] = { w:0,l:0,pf:0,pa:0,divW:0,divL:0,confW:0,confL:0 };
    league.schedules[t.id] = buildNFLScheduleForTeam(t.id, seasonNumber);
  }

  return league;
}

function startNewProSeason(){
  state.phase = "PRO";
  state.week = 1;
  state.seasonWins = 0;
  state.seasonLosses = 0;

  state.pro.stats = { games:0, yards:0, tds:0, ints:0, tackles:0, sacks:0 };

  // pay signing season salary upfront weekly? We'll do per week after each game.
  if(!state.pro.league){
    state.pro.league = buildLeagueSeason(state.pro.seasonsPlayed + 1);
  } else {
    state.pro.league = buildLeagueSeason(state.pro.seasonsPlayed + 1);
  }

  // Set user schedule
  state.pro.schedule = state.pro.league.schedules[state.pro.teamId];

  logLine(`--- PRO SEASON ${state.pro.seasonsPlayed + 1} START (${getProTeam(state.pro.teamId).name}) ---`);
  logLine("17-game season + bye. Advance Week to practice + play/sim.");
}

function simulateLeagueWeek(week){
  const league = state.pro.league;
  if(!league.resultsByWeek[week]) league.resultsByWeek[week] = [];

  // Create matchups from schedules (avoid duplicates by hashing)
  const seen = new Set();
  for(const team of NFL.teams){
    const entry = league.schedules[team.id].find(x=>x.week===week);
    if(!entry || entry.isBye) continue;
    const a = team.id;
    const b = entry.oppId;
    const key = [a,b].sort().join("-");
    if(seen.has(key)) continue;
    seen.add(key);

    // determine home/away: look at a's schedule entry home flag
    const homeA = !!entry.home;
    const homeTeam = homeA ? a : b;
    const awayTeam = homeA ? b : a;

    // strength based on pseudo power (randomized each season)
    const powerA = baseTeamPower(a);
    const powerB = baseTeamPower(b);
    const homeBoost = 2.5;

    const scoreHome = Math.max(6, Math.round(21 + (homeTeam===a?powerA:powerB)*0.6 + rnd(-10,10) + homeBoost));
    const scoreAway = Math.max(3, Math.round(20 + (awayTeam===a?powerA:powerB)*0.6 + rnd(-10,10)));

    const winHome = scoreHome >= scoreAway;
    const winner = winHome ? homeTeam : awayTeam;
    const loser = winHome ? awayTeam : homeTeam;

    applyProResult(league, winner, loser, scoreHome, scoreAway, homeTeam, awayTeam);
    league.resultsByWeek[week].push({ homeTeam, awayTeam, scoreHome, scoreAway });
  }
}

function baseTeamPower(teamId){
  // stable-ish power with teamId seed
  const n = parseInt(teamId.replace("P",""),10);
  const seed = (n*9973) % 100;
  return 55 + (seed%30) + rnd(-3,3);
}

function applyProResult(league, winner, loser, scoreHome, scoreAway, homeTeam, awayTeam){
  const recW = league.records[winner];
  const recL = league.records[loser];
  recW.w++; recL.l++;

  // points
  const wPts = (winner===homeTeam) ? scoreHome : scoreAway;
  const lPts = (loser===homeTeam) ? scoreHome : scoreAway;
  recW.pf += wPts; recW.pa += lPts;
  recL.pf += lPts; recL.pa += wPts;

  // division/conf breakdown (simplified: if same div/conference)
  const tW = getProTeam(winner), tL = getProTeam(loser);
  if(tW.conf === tL.conf){
    recW.confW++; recL.confL++;
    if(tW.div === tL.div){ recW.divW++; recL.divL++; }
  }
}

function userProWeek(week){
  const sched = state.pro.schedule.find(x=>x.week===week);
  if(!sched) return;
  if(sched.isBye){
    logLine("BYE WEEK: no game this week.");
    // recover fatigue
    state.life.fatigue = clamp(state.life.fatigue - 10, 0, 100);
    return;
  }
  const opp = getProTeam(sched.oppId);
  const oppOvr = clamp(baseTeamPower(opp.id) + rnd(-3,3), 55, 92);
  logLine(`Pro Game Week ${week}: vs ${opp.name} (${sched.home ? "Home" : "Away"})`);
  const win = simulatePlayerGame("PRO", oppOvr);
  if(win) state.seasonWins++; else state.seasonLosses++;

  // weekly paycheck
  const paycheck = Math.round(state.pro.contract.annual / 17);
  state.pro.money += paycheck;
  state.life.money = state.pro.money;
  logLine(`Paycheck: +${fmtMoney(paycheck)}`);

  // update contract years after season end only
}

function determineNFLPlayoffs(){
  const league = state.pro.league;
  // 7 teams per conference: 4 division winners + 3 wildcards
  function confTeams(conf){
    return NFL.teams.filter(t=>t.conf===conf).map(t=>({
      id:t.id, conf:t.conf, div:t.div, rec:league.records[t.id]
    }));
  }
  function sortTeams(list){
    // sort by wins then point diff
    return list.sort((a,b)=>{
      if(b.rec.w !== a.rec.w) return b.rec.w - a.rec.w;
      const da = a.rec.pf - a.rec.pa;
      const db = b.rec.pf - b.rec.pa;
      return db - da;
    });
  }
  function getDivisionWinners(conf){
    const winners = [];
    for(const div of NFL.divs){
      const list = confTeams(conf).filter(x=>x.div===div);
      winners.push(sortTeams(list)[0]);
    }
    return sortTeams(winners);
  }

  const afcAll = confTeams("AFC");
  const nfcAll = confTeams("NFC");

  const afcDivW = getDivisionWinners("AFC");
  const nfcDivW = getDivisionWinners("NFC");

  const afcWC = sortTeams(afcAll.filter(x=>!afcDivW.some(w=>w.id===x.id))).slice(0,3);
  const nfcWC = sortTeams(nfcAll.filter(x=>!nfcDivW.some(w=>w.id===x.id))).slice(0,3);

  const afcSeeds = sortTeams([...afcDivW, ...afcWC]).slice(0,7);
  const nfcSeeds = sortTeams([...nfcDivW, ...nfcWC]).slice(0,7);

  // Seeds 1-7 in order
  return { afcSeeds, nfcSeeds };
}

function simulatePlayoffRound(seeds){
  // NFL format: seed1 bye; wild card: 2v7 3v6 4v5; divisional: 1 vs lowest, remaining; conf: winners; SB
  function game(a,b,tag){
    const pa = baseTeamPower(a.id) + rnd(-4,4);
    const pb = baseTeamPower(b.id) + rnd(-4,4);
    const winA = (pa - pb) + rnd(-12,12) >= 0;
    const winner = winA ? a : b;
    const loser = winA ? b : a;
    logLine(`${tag}: ${getProTeam(winner.id).name} beats ${getProTeam(loser.id).name}`);
    return winner;
  }

  const s = seeds.slice(); // already sorted seed order
  const seed1 = s[0];

  // Wild card
  const wcWinners = [
    game(s[1], s[6], "Wild Card"),
    game(s[2], s[5], "Wild Card"),
    game(s[3], s[4], "Wild Card"),
  ];

  // Divisional: seed1 vs lowest winner
  wcWinners.sort((a,b)=>b.rec.w - a.rec.w); // approximate by record
  const lowest = wcWinners[2];
  const other = wcWinners.slice(0,2);

  const divWinners = [
    game(seed1, lowest, "Divisional"),
    game(other[0], other[1], "Divisional")
  ];

  // Conference
  const confWinner = game(divWinners[0], divWinners[1], "Conference Championship");
  return confWinner;
}

function finishProSeason(){
  const league = state.pro.league;
  // determine playoffs
  const { afcSeeds, nfcSeeds } = determineNFLPlayoffs();
  league.playoffs = { afcSeeds, nfcSeeds };

  logLine("--- NFL PLAYOFFS ---");
  const afcChamp = simulatePlayoffRound(afcSeeds);
  const nfcChamp = simulatePlayoffRound(nfcSeeds);
  logLine("--- SUPER BOWL ---");
  // Super Bowl
  const pa = baseTeamPower(afcChamp.id) + rnd(-4,4);
  const pb = baseTeamPower(nfcChamp.id) + rnd(-4,4);
  const winA = (pa - pb) + rnd(-12,12) >= 0;
  const champ = winA ? afcChamp : nfcChamp;
  league.champ = champ.id;
  logLine(`SUPER BOWL CHAMPIONS: ${getProTeam(champ.id).name}`);

  // end-of-season contract progression + eligibility
  state.pro.seasonsPlayed += 1;
  // yearly salary bonus (season-end bonus)
  const bonus = Math.round(state.pro.contract.annual * 0.10);
  state.pro.money += bonus;
  state.life.money = state.pro.money;
  logLine(`Season Bonus: +${fmtMoney(bonus)}`);

  // decrement contract years
  state.pro.contract.yearsLeft = Math.max(0, state.pro.contract.yearsLeft - 1);

  if(state.pro.seasonsPlayed >= 3){
    state.pro.freeAgencyEligible = true;
    logLine("You are now eligible for Free Agency (3+ pro seasons).");
  }

  // offseason progression
  offseasonProgression();

  // if contract expired, force FA
  if(state.pro.contract.yearsLeft <= 0){
    logLine("Contract expired. You must sign a new deal.");
    enterFreeAgency(true);
  } else {
    // optionally offer extension if eligible
    if(state.pro.freeAgencyEligible){
      logLine("You can request an extension or test Free Agency (Contracts tab).");
    }
  }

  // start next season if not in FA
  if(!state.pro.inFreeAgency){
    state.pro.league = null;
    startNewProSeason();
  }
}

function offseasonProgression(){
  // small attribute growth or decline
  const r = state.player.ratings;
  // improve one random stat, maybe lose one if fatigue/grades bad
  const gain = pick(["awareness","stamina","strength","speed","agility"]);
  r[gain] = clamp(r[gain] + 1, 1, 99);
  if(state.life.grades < 55 && chance(0.35)){
    r.awareness = clamp(r.awareness - 1, 1, 99);
  }
  state.life.fatigue = clamp(state.life.fatigue - 18, 0, 100);
  state.life.grades = clamp(state.life.grades + 4, 0, 100);
  state.life.social = clamp(state.life.social + 2, 0, 100);
  logLine(`Offseason Training: +1 ${gain.toUpperCase()}`);
}

/* ---------------- Free Agency + Extensions ---------------- */
function enterFreeAgency(forced=false){
  if(state.phase !== "PRO") return;
  if(!state.pro.freeAgencyEligible && !forced){
    logLine("Not eligible for free agency yet (requires 3 pro seasons).");
    return;
  }
  state.pro.inFreeAgency = true;
  state.pro.offers = generateFAOffers();
  logLine("Entered Free Agency. Review offers in Contracts tab.");
}

function generateFAOffers(){
  const ovr = calcOVR();
  const pos = state.player.pos;

  // offer quality based on OVR
  const market = clamp((ovr - 65) / 35, 0, 1); // 65->0, 100->1
  const base = 900000 + market * 22000000;

  // position multipliers
  const mult = (pos==="QB") ? 1.35 : (pos==="WR") ? 1.15 : (pos==="RB") ? 1.05 : 1.0;

  // choose teams that "need" your position
  const needTeams = NFL.teams.filter(t=>t.needs===pos);
  const pool = shuffle([...needTeams, ...NFL.teams]).slice(0,8);

  const offers = pool.map(t=>{
    const years = clamp(Math.round(2 + market*3 + rnd(-1,1)), 1, 5);
    const annual = Math.round((base * mult) * (0.75 + rnd(0,30)*0.01));
    const bonus = Math.round(annual * (0.25 + market*0.25));
    const role = (annual > 12000000) ? "Franchise" : (annual > 5000000) ? "Starter" : "Depth";
    return { teamId:t.id, years, annual, bonus, role };
  }).sort((a,b)=>b.annual-a.annual);

  return offers;
}

function signOffer(idx){
  const offer = state.pro.offers[idx];
  if(!offer) return;
  state.pro.teamId = offer.teamId;
  state.pro.contract = { yearsLeft: offer.years, totalYears: offer.years, annual: offer.annual, signedAtSeason: state.pro.seasonsPlayed+1 };
  state.pro.money += offer.bonus;
  state.life.money = state.pro.money;
  state.pro.inFreeAgency = false;
  state.pro.offers = [];
  logLine(`Signed with ${getProTeam(offer.teamId).name}: ${offer.years}y / ${fmtMoney(offer.annual)}/yr + ${fmtMoney(offer.bonus)} bonus (${offer.role}).`);
  // start next season
  state.pro.league = null;
  startNewProSeason();
}

function requestExtension(){
  if(state.phase !== "PRO") return;
  if(!state.pro.freeAgencyEligible){
    logLine("Extensions unlocked after 3 pro seasons.");
    return;
  }
  if(state.pro.contract.yearsLeft > 1){
    logLine("Extension: Usually negotiated with 1 year left. (You have more than 1 year remaining.)");
    // still allow
  }
  const ovr = calcOVR();
  const pos = state.player.pos;
  const market = clamp((ovr - 65) / 35, 0, 1);
  const mult = (pos==="QB") ? 1.35 : (pos==="WR") ? 1.15 : (pos==="RB") ? 1.05 : 1.0;
  const annual = Math.round((1200000 + market*18000000) * mult);
  const years = clamp(Math.round(2 + market*3), 2, 5);
  const bonus = Math.round(annual * (0.2 + market*0.35));
  state.pro.offers = [{ teamId: state.pro.teamId, years, annual, bonus, role:"Extension" }];
  state.pro.inFreeAgency = true; // reuse offers UI
  logLine("Extension offer generated. Review in Contracts tab.");
}

/* ---------------- End-of-season checks ---------------- */
function endOfHSYear(){
  logLine(`--- HS Year ${state.year} Complete: ${state.seasonWins}-${state.seasonLosses} ---`);
  state.year += 1;
  state.week = 1;
  initHSSeason();

  // offseason
  state.player.ratings.stamina = clamp(state.player.ratings.stamina + 1, 1, 99);
  state.life.fatigue = clamp(state.life.fatigue - 15, 0, 100);

  if(state.year > 4){
    logLine("High School complete: Choose a college offer (Recruiting tab).");
  } else {
    logLine(`Starting HS Year ${state.year}.`);
  }
}

function endOfCollegeYear(){
  logLine(`--- College Year ${state.year} Complete: ${state.seasonWins}-${state.seasonLosses} ---`);
  state.year += 1;
  state.week = 1;

  // offseason progression
  state.player.ratings.awareness = clamp(state.player.ratings.awareness + 1, 1, 99);
  state.life.fatigue = clamp(state.life.fatigue - 12, 0, 100);

  if(state.year > 4){
    // must declare
    if(!state.college.declared){
      logLine("College complete: You are required to declare for the draft.");
      state.college.declared = true;
      state.draft.declared = true;
      const proj = state.college.draftProjection || computeProjection(40);
      state.draft.invitedCombine = (proj.score >= 60) || (calcOVR() >= 80);
    }
    state.phase = "DRAFT";
    state.week = 1;
    runDraft();
  } else {
    initCollegeSeason();
    logLine(`Starting College Year ${state.year}.`);
  }
}

/* ---------------- Advance Week core loop ---------------- */
function advanceWeek(){
  if(state.phase === "HS"){
    hsWeekProgression();

    if(state.week >=1 && state.week <= 12){
      const g = state.hs.schedule.find(x=>x.week===state.week);
      const win = simulatePlayerGame("HS", g.oppOvr);
      if(win) state.seasonWins++; else state.seasonLosses++;
    } else if(state.week === 13){
      // playoffs setup
      if(qualifyHSPlayoffs()){
        makeHSBracket();
        playHSPlayoffRound(); // quarters
      } else {
        logLine("HS Playoffs: Not qualified this year.");
      }
    } else if(state.week === 14){
      if(state.hs.playoff && !state.hs.playoff.champion && !state.hs.playoff.userEliminated){
        playHSPlayoffRound(); // semis
      }
    } else if(state.week === 15){
      if(state.hs.playoff && !state.hs.playoff.champion && !state.hs.playoff.userEliminated){
        playHSPlayoffRound(); // championship
      }
      endOfHSYear();
      save();
      renderCareer();
      return;
    }

    state.week += 1;
    updateRecruitProfile();
    save();
    renderCareer();
    return;
  }

  if(state.phase === "COLLEGE"){
    // simulate other college teams week
    simulateOtherCollegeWeek(state.week);

    collegeWeekProgression();

    if(state.week >=1 && state.week <= 12){
      const g = state.college.schedule.find(x=>x.week===state.week);
      const opp = COLLEGES.find(c=>c.id===g.oppId);
      logLine(`College Game Week ${state.week}: vs ${opp.name} ${g.confGame ? "(Conf)" : "(Non-Conf)"}`);
      const win = simulatePlayerGame("COLLEGE", g.oppOvr);
      const stMy = state.college.standings[state.college.collegeId];
      const stOpp = state.college.standings[g.oppId];
      if(win){ state.seasonWins++; stMy.w++; if(g.confGame) stMy.confW++; stOpp.l++; if(g.confGame) stOpp.confL++; }
      else { state.seasonLosses++; stMy.l++; if(g.confGame) stMy.confL++; stOpp.w++; if(g.confGame) stOpp.confW++; }
      computeCollegeRankings();
    } else if(state.week === 13){
      playCollegeConfChampionship();
    } else if(state.week === 14){
      playCollegePostseason();
      // end year after postseason
      endOfCollegeYear();
      save();
      renderCareer();
      return;
    }

    state.week += 1;
    save();
    renderCareer();
    return;
  }

  if(state.phase === "DRAFT"){
    runDraft();
    save();
    renderCareer();
    return;
  }

  if(state.phase === "PRO"){
    // if in free agency, no week sim
    if(state.pro.inFreeAgency){
      logLine("Free Agency: Sign a deal in Contracts tab to continue.");
      renderCareer();
      return;
    }

    // League week simulation
    const week = state.week;

    // practice impacts: small fatigue and small stat chance
    state.life.fatigue = clamp(state.life.fatigue + 2, 0, 100);
    if(chance(0.20)){
      const up = pick(["awareness","stamina","strength","speed","agility"]);
      state.player.ratings[up] = clamp(state.player.ratings[up] + 1, 1, 99);
      logLine(`Practice: +1 ${up.toUpperCase()}`);
    }

    simulateLeagueWeek(week);
    userProWeek(week);

    state.week += 1;

    if(state.week > 18){
      // end regular season
      finishProSeason();
    }

    save();
    renderCareer();
    return;
  }
}

/* ---------------- Rendering ---------------- */
function setActiveTab(tab){
  state.ui.activeTab = tab;
  document.querySelectorAll(".tabbtn").forEach(btn=>{
    const is = btn.dataset.tab === tab;
    btn.classList.toggle("primary", is);
    btn.classList.toggle("ghost", !is);
  });
  renderTab();
}

function renderBars(){
  const g = clamp(state.life.grades, 0, 100);
  const s = clamp(state.life.social, 0, 100);
  const f = clamp(state.life.fatigue, 0, 100);

  $("gradesText").textContent = `${g}/100`;
  $("socialText").textContent = `${s}/100`;
  $("fatigueText").textContent = `${f}/100`;

  $("gradesBar").style.width = `${g}%`;
  $("socialBar").style.width = `${s}%`;
  $("fatigueBar").style.width = `${f}%`;

  // money display based on phase
  if(state.phase === "COLLEGE") state.life.money = state.college.money;
  if(state.phase === "PRO") state.life.money = state.pro.money;
  $("moneyText").textContent = fmtMoney(state.life.money || 0);
}

function renderPlayerCard(){
  const p = state.player;
  const eff = getEffectiveRatings();
  const ovr = calcOVR();

  const phaseLine =
    state.phase === "HS" ? `High School • Year ${state.year} • Week ${state.week}` :
    state.phase === "COLLEGE" ? `College • Year ${state.year} • Week ${state.week}` :
    state.phase === "DRAFT" ? `Draft` :
    state.phase === "PRO" ? `Pros • Season ${state.pro.seasonsPlayed + 1} • Week ${state.week}` :
    "";

  const hsRecruit = state.phase === "HS"
    ? `Recruit: ${state.hs.recruit.stars}⭐ • Rating ${state.hs.recruit.rating} • Rank #${state.hs.recruit.rank}`
    : "";

  const college = (state.phase === "COLLEGE")
    ? COLLEGES.find(c=>c.id===state.college.collegeId)
    : null;

  const collegeLine = college ? `${college.stars}⭐ ${college.name} • Conf: ${CONFERENCES.find(x=>x.id===college.confId)?.name || ""}` : "";

  const proj = (state.phase === "COLLEGE" && state.college.draftProjection)
    ? `Draft Projection: ${state.college.draftProjection.text} (score ${state.college.draftProjection.score})`
    : "";

  const proLine = (state.phase === "PRO")
    ? `${getProTeam(state.pro.teamId).name} • Contract: ${state.pro.contract.yearsLeft}y left @ ${fmtMoney(state.pro.contract.annual)}/yr`
    : "";

  $("playerCard").innerHTML = `
    <div><b>${p.name}</b> — ${p.pos} (${p.archetypeName}) • OVR <b>${ovr}</b></div>
    <div class="muted">${p.hand} • ${p.height}, ${p.weight} lbs • ${phaseLine}</div>
    <div class="muted">${p.hometown || ""}</div>
    ${state.phase==="HS" ? `<div class="muted">HS Team: ${state.hs.teamName}</div>` : ""}
    ${hsRecruit ? `<div class="muted">${hsRecruit}</div>` : ""}
    ${collegeLine ? `<div class="muted">${collegeLine}</div>` : ""}
    ${proj ? `<div class="muted">${proj}</div>` : ""}
    ${proLine ? `<div class="muted">${proLine}</div>` : ""}
    <div class="hr"></div>
    <div>Speed: ${eff.speed} • Strength: ${eff.strength} • Agility: ${eff.agility}</div>
    <div>Awareness: ${eff.awareness} • Stamina: ${eff.stamina}</div>
  `;
}

function renderOverviewTab(){
  const ovr = calcOVR();
  let html = `
    <h3>Overview</h3>
    <div class="small muted">Your career at a glance.</div>
    <div class="hr"></div>
  `;

  if(state.phase === "HS"){
    html += `
      <div class="row">
        <span class="pill good">HS Year ${state.year}</span>
        <span class="pill">Record ${state.seasonWins}-${state.seasonLosses}</span>
        <span class="pill warn">OVR ${ovr}</span>
      </div>
      <div class="hr"></div>
      <div class="small muted">HS Stats</div>
      <div class="small">Games: ${state.hs.stats.games} • Yards: ${state.hs.stats.yards} • TD: ${state.hs.stats.tds} ${state.player.pos==="QB" ? `• INT: ${state.hs.stats.ints}` : ""}</div>
    `;
  }

  if(state.phase === "COLLEGE"){
    const c = COLLEGES.find(x=>x.id===state.college.collegeId);
    html += `
      <div class="row">
        <span class="pill good">${c.stars}⭐ ${c.name}</span>
        <span class="pill">Record ${state.seasonWins}-${state.seasonLosses}</span>
        <span class="pill warn">OVR ${ovr}</span>
        <span class="pill">${CONFERENCES.find(x=>x.id===c.confId)?.name} Conf</span>
      </div>
      <div class="hr"></div>
      <div class="small muted">College Stats</div>
      <div class="small">Games: ${state.college.stats.games} • Yards: ${state.college.stats.yards} • TD: ${state.college.stats.tds} ${state.player.pos==="QB" ? `• INT: ${state.college.stats.ints}` : ""}</div>
      <div class="hr"></div>
      <div class="small muted">Top 10 Rankings</div>
      <ol class="list">
        ${state.college.rankings.slice(0,10).map(id=>`<li>${COLLEGES.find(c=>c.id===id)?.name || id} (${getCollegeRec(id)})</li>`).join("")}
      </ol>
    `;
  }

  if(state.phase === "PRO"){
    html += `
      <div class="row">
        <span class="pill good">${getProTeam(state.pro.teamId).conf}</span>
        <span class="pill">${getProTeam(state.pro.teamId).div}</span>
        <span class="pill">Record ${state.seasonWins}-${state.seasonLosses}</span>
        <span class="pill warn">OVR ${ovr}</span>
      </div>
      <div class="hr"></div>
      <div class="small muted">This Season</div>
      <div class="small">Week ${state.week} / 18 (17 games + bye)</div>
      <div class="small">Money: ${fmtMoney(state.pro.money)} • Contract: ${state.pro.contract.yearsLeft} years left</div>
    `;
  }

  if(state.phase === "DRAFT"){
    html += `<div class="small muted">Draft is running. Click Advance Week to proceed.</div>`;
  }

  return html;
}

function renderSeasonTab(){
  let html = `<h3>Season</h3><div class="small muted">Schedule + postseason.</div><div class="hr"></div>`;

  if(state.phase === "HS"){
    html += `<div class="row"><span class="pill">HS Week ${state.week}</span><span class="pill">Record ${state.seasonWins}-${state.seasonLosses}</span></div>`;
    html += `<table class="table"><thead><tr><th>Week</th><th>Opponent</th><th>OVR</th><th>Type</th></tr></thead><tbody>`;
    for(const g of state.hs.schedule){
      html += `<tr><td>${g.week}</td><td>${g.opp}</td><td>${g.oppOvr}</td><td>Regular</td></tr>`;
    }
    html += `</tbody></table>`;
    html += `<div class="hr"></div><div class="small muted">Playoffs</div>`;
    if(state.week <= 12){
      html += `<div class="small">Qualify for playoffs at <b>8+</b> wins (8-team bracket).</div>`;
    } else {
      if(state.hs.playoff){
        const champ = state.hs.playoff.champion ? state.hs.playoff.champion.name : "TBD";
        html += `<div class="small">Bracket status: Champion: <b>${champ}</b></div>`;
      } else {
        html += `<div class="small">No playoff bracket this year.</div>`;
      }
    }
  }

  if(state.phase === "COLLEGE"){
    html += `<div class="row"><span class="pill">College Week ${state.week}</span><span class="pill">Record ${state.seasonWins}-${state.seasonLosses}</span></div>`;
    html += `<table class="table"><thead><tr><th>Week</th><th>Opponent</th><th>Conf</th><th>OVR</th></tr></thead><tbody>`;
    for(const g of state.college.schedule){
      const played = (g.week < state.week) ? `<span class="pill good">Played</span>` : "";
      html += `<tr><td>${g.week}</td><td>${g.oppName} ${played}</td><td>${g.confGame ? "Yes" : "No"}</td><td>${g.oppOvr}</td></tr>`;
    }
    html += `</tbody></table>`;
    html += `<div class="hr"></div><div class="small muted">Conference Standings (your conf)</div>`;
    const my = COLLEGES.find(c=>c.id===state.college.collegeId);
    const confTeams = COLLEGES.filter(c=>c.confId===my.confId);
    confTeams.sort((a,b)=>{
      const sa = state.college.standings[a.id], sb = state.college.standings[b.id];
      const aKey = (sa.confW-sa.confL)*10 + (sa.w-sa.l) + a.prestige/100;
      const bKey = (sb.confW-sb.confL)*10 + (sb.w-sb.l) + b.prestige/100;
      return bKey - aKey;
    });
    html += `<table class="table"><thead><tr><th>Team</th><th>Conf</th><th>Overall</th></tr></thead><tbody>`;
    for(const t of confTeams){
      const st = state.college.standings[t.id];
      html += `<tr><td>${t.name}${t.id===my.id?` <span class="pill good">YOU</span>`:""}</td><td>${st.confW}-${st.confL}</td><td>${st.w}-${st.l}</td></tr>`;
    }
    html += `</tbody></table>`;
    html += `<div class="hr"></div><div class="small">Postseason: Week 13 conference championship, Week 14 bowls + playoff.</div>`;
  }

  if(state.phase === "PRO"){
    html += `<div class="row"><span class="pill">Pro Week ${state.week}</span><span class="pill">Record ${state.seasonWins}-${state.seasonLosses}</span></div>`;
    html += `<table class="table"><thead><tr><th>Week</th><th>Opponent</th><th>Home/Away</th><th>Tag</th></tr></thead><tbody>`;
    for(const g of state.pro.schedule){
      if(g.isBye){
        html += `<tr><td>${g.week}</td><td>BYE</td><td>-</td><td>-</td></tr>`;
      } else {
        const opp = getProTeam(g.oppId);
        html += `<tr><td>${g.week}</td><td>${opp.name}</td><td>${g.home?"Home":"Away"}</td><td>${g.tag}</td></tr>`;
      }
    }
    html += `</tbody></table>`;
    html += `<div class="hr"></div><div class="small muted">Playoffs</div>`;
    html += `<div class="small">After week 18, playoffs simulate: 7 teams per conference (division winners + wildcards).</div>`;
  }

  return html;
}

function renderRecruitTab(){
  let html = `<h3>Recruiting</h3><div class="small muted">Offers, needs, and competition.</div><div class="hr"></div>`;

  if(state.phase === "HS"){
    const offers = state.hs.offers.map(id=>COLLEGES.find(c=>c.id===id)).filter(Boolean);
    const pos = state.player.pos;

    html += `
      <div class="row">
        <span class="pill good">${state.hs.recruit.stars}⭐</span>
        <span class="pill">Rank #${state.hs.recruit.rank}</span>
        <span class="pill warn">Rating ${state.hs.recruit.rating}</span>
        <span class="pill">Position ${pos}</span>
      </div>
      <div class="hr"></div>
      <div class="small muted">Offers (${offers.length})</div>
      ${offers.length ? `<div class="row" style="margin-top:8px;">${offers.map(c=>`<span class="pill good">${c.stars}⭐ ${c.name}</span>`).join(" ")}</div>` : `<div class="small">No offers yet.</div>`}
      <div class="hr"></div>
    `;

    // Top interest list with needs info for your position
    const top = state.hs.interest
      .map(row=>{
        const c = COLLEGES.find(x=>x.id===row.collegeId);
        return { row, c };
      })
      .filter(x=>x.c)
      .sort((a,b)=>b.row.interest-a.row.interest)
      .slice(0, 12);

    html += `<div class="small muted">Top Schools (Interest + Need at ${pos})</div>`;
    html += `<table class="table"><thead><tr><th>College</th><th>Stars</th><th>Interest</th><th>Need</th><th>Filled</th><th></th></tr></thead><tbody>`;
    for(const x of top){
      const need = x.row.needs[pos] ?? 0;
      const filled = x.row.filled[pos] ?? 0;
      const full = need>0 && filled>=need;
      html += `<tr>
        <td>${x.c.name}</td>
        <td>${x.c.stars}⭐</td>
        <td>${x.row.interest}${x.row.offered ? ` <span class="pill good">OFFER</span>` : ""}</td>
        <td>${need}</td>
        <td>${filled}${full ? ` <span class="pill bad">FULL</span>` : ""}</td>
        <td>${(state.year>4) ? `<button type="button" data-commit="${x.c.id}">Commit</button>` : ""}</td>
      </tr>`;
    }
    html += `</tbody></table>`;

    const canCommit = state.year > 4;
    html += `<div class="hr"></div>`;
    if(canCommit){
      if(offers.length){
        html += `<div class="small">HS complete — choose your college:</div>
                 <div class="row" style="margin-top:8px;">
                   ${offers.map(c=>`<button type="button" data-commit="${c.id}">Commit: ${c.name}</button>`).join("")}
                 </div>`;
      } else {
        const walkOn = COLLEGES.filter(c=>c.stars===1).slice(0,5);
        html += `<div class="small"><span class="pill bad">No offers</span> Walk-on options:</div>
                 <div class="row" style="margin-top:8px;">
                   ${walkOn.map(c=>`<button type="button" data-commit="${c.id}">Walk-on: ${c.name}</button>`).join("")}
                 </div>`;
      }
    } else {
      html += `<div class="small muted">Recruiting runs during HS. In Year 5 you can commit (after HS ends).</div>`;
    }

    return html;
  }

  if(state.phase === "COLLEGE"){
    const c = COLLEGES.find(x=>x.id===state.college.collegeId);
    html += `
      <div class="row">
        <span class="pill good">${c.stars}⭐ ${c.name}</span>
        <span class="pill">${CONFERENCES.find(x=>x.id===c.confId)?.name} Conf</span>
        ${state.college.declared ? `<span class="pill good">Declared</span>` : `<span class="pill warn">Not Declared</span>`}
        ${canDeclare() ? `<button class="warn" type="button" id="btnDeclareInline">Declare for Draft</button>` : ""}
      </div>
      <div class="hr"></div>
      <div class="small muted">Draft Projection</div>
      <div class="small">
        ${state.college.draftProjection ? `${state.college.draftProjection.text} (score ${state.college.draftProjection.score})` : "Starts at the beginning of Year 3"}
      </div>
      <div class="hr"></div>
      <div class="small muted">Note</div>
      <div class="small">College recruiting is simplified in v0.5 (focus is player career + postseason + draft).</div>
    `;
    return html;
  }

  if(state.phase === "PRO"){
    html += `<div class="small muted">Recruiting is complete. Use Contracts for free agency and Season for schedule.</div>`;
    return html;
  }

  return `<div class="small muted">Recruiting view not available.</div>`;
}

function renderShopTab(){
  let html = `<h3>Shop</h3><div class="small muted">Gear boosts carry into the pros. Luxury is pro-only and gives no boosts.</div><div class="hr"></div>`;
  const wallet = (state.phase==="PRO") ? state.pro.money : (state.phase==="COLLEGE") ? state.college.money : state.life.money;
  html += `<div class="small">Money: <b>${fmtMoney(wallet||0)}</b></div>`;
  html += `<div class="hr"></div>`;

  // inventory
  const inv = (state.college.inventory||[]).map(x=>SHOP_ITEMS.find(i=>i.id===x.itemId)).filter(Boolean);
  const eq = state.college.equipped || {};
  html += `<div class="small muted">Inventory (click to equip/unequip)</div>`;
  if(inv.length){
    html += `<div class="row" style="margin-top:8px;">`;
    for(const item of inv){
      const equipped = item.equipSlot && eq[item.equipSlot] === item.id;
      html += `<button type="button" class="${equipped?"primary":"ghost"}" data-equip="${item.id}">${equipped?"Equipped: ":""}${item.name}</button>`;
    }
    html += `</div>`;
  } else {
    html += `<div class="small">No items yet.</div>`;
  }

  html += `<div class="hr"></div><div class="small muted">Gear + Services</div>`;
  html += `<table class="table"><thead><tr><th>Item</th><th>Cost</th><th>Effect</th><th></th></tr></thead><tbody>`;
  for(const i of SHOP_ITEMS){
    const eff = [];
    if(i.effects && Object.keys(i.effects).length) eff.push(...Object.entries(i.effects).map(([k,v])=>`${k}+${v}`));
    if(i.social) eff.push(`social+${i.social}`);
    if(i.gradeBoost) eff.push(`grades+${i.gradeBoost}`);
    html += `<tr>
      <td><b>${i.name}</b><div class="small muted">${i.desc}</div></td>
      <td>${fmtMoney(i.cost)}</td>
      <td class="small">${eff.join(", ")}</td>
      <td><button type="button" data-buy="${i.id}">Buy</button></td>
    </tr>`;
  }
  html += `</tbody></table>`;

  if(state.phase === "PRO"){
    html += `<div class="hr"></div><div class="small muted">Luxury (no boosts)</div>`;
    html += `<table class="table"><thead><tr><th>Item</th><th>Cost</th><th></th></tr></thead><tbody>`;
    for(const i of LUXURY_ITEMS){
      html += `<tr>
        <td><b>${i.name}</b><div class="small muted">${i.desc}</div></td>
        <td>${fmtMoney(i.cost)}</td>
        <td><button type="button" data-lux="${i.id}">Buy</button></td>
      </tr>`;
    }
    html += `</tbody></table>`;
  }

  return html;
}

function renderContractTab(){
  let html = `<h3>Contracts</h3><div class="small muted">Rookie deal → extensions → free agency (eligible after 3 seasons).</div><div class="hr"></div>`;

  if(state.phase !== "PRO"){
    html += `<div class="small muted">Contracts apply once you reach the pros.</div>`;
    return html;
  }

  const team = getProTeam(state.pro.teamId);
  const c = state.pro.contract;

  html += `
    <div class="row">
      <span class="pill good">${team.name}</span>
      <span class="pill">Salary ${fmtMoney(c.annual)}/yr</span>
      <span class="pill">Years left ${c.yearsLeft}</span>
      <span class="pill warn">${state.pro.freeAgencyEligible ? "FA Eligible" : "FA Locked"}</span>
    </div>
    <div class="hr"></div>
    <div class="small">Pro Money: <b>${fmtMoney(state.pro.money)}</b></div>
    <div class="small">Roster: ${state.pro.rosterSpot}</div>
    <div class="hr"></div>
    <div class="row">
      <button type="button" class="ghost" id="btnRequestExtension">Request Extension</button>
      <button type="button" class="warn" id="btnEnterFA">Enter Free Agency</button>
    </div>
  `;

  if(state.pro.inFreeAgency){
    html += `<div class="hr"></div><div class="small muted">Offers</div>`;
      # =========================
# PASTE FROM HERE (this continues your game_js = r""" ... )
# =========================
      if(!state.pro.offers || !state.pro.offers.length){
        html += `<div class="small">No offers yet. (Advance time or request extension / enter FA again.)</div>`;
      } else {
        html += `<table class="table">
          <thead><tr><th>Team</th><th>Role</th><th>Years</th><th>Annual</th><th>Bonus</th><th></th></tr></thead><tbody>`;
        state.pro.offers.forEach((o, idx)=>{
          const t = getProTeam(o.teamId);
          html += `<tr>
            <td><b>${t.name}</b><div class="small muted">${t.conf} ${t.div}</div></td>
            <td>${o.role}</td>
            <td>${o.years}</td>
            <td>${fmtMoney(o.annual)}</td>
            <td>${fmtMoney(o.bonus)}</td>
            <td><button type="button" data-sign="${idx}">Sign</button></td>
          </tr>`;
        });
        html += `</tbody></table>`;
      }
      html += `<div class="hr"></div><div class="small muted">Tip</div>
               <div class="small">Higher OVR and strong seasons increase offer quality. Teams that need your position pay more.</div>`;
  }

  return html;
}

function renderLogsTab(){
  let html = `
    <h3>Log</h3>
    <div class="small muted">Most recent events appear at the top.</div>
    <div class="hr"></div>
    <div class="row">
      <button type="button" class="ghost" id="btnClearLog">Clear Log</button>
    </div>
    <div class="log" id="logBox"></div>
  `;
  return html;
}

function renderTab(){
  const tab = state.ui.activeTab || "overview";
  let html = "";
  if(tab === "overview") html = renderOverviewTab();
  else if(tab === "season") html = renderSeasonTab();
  else if(tab === "recruit") html = renderRecruitTab();
  else if(tab === "shop") html = renderShopTab();
  else if(tab === "contract") html = renderContractTab();
  else if(tab === "logs") html = renderLogsTab();
  else html = renderOverviewTab();

  $("tabContent").innerHTML = html;

  // connect log element when Logs tab is shown
  const logBox = $("logBox");
  if(logBox) state.ui.logEl = logBox;

  attachTabHandlers();
}

function attachTabHandlers(){
  const tc = $("tabContent");
  if(!tc) return;

  tc.querySelectorAll("[data-commit]").forEach(btn=>{
    btn.onclick = () => {
      const id = btn.dataset.commit;
      enterCollege(id);
      save();
      renderCareer();
    };
  });

  tc.querySelectorAll("[data-buy]").forEach(btn=>{
    btn.onclick = () => {
      buyItem(btn.dataset.buy);
      save();
      renderCareer();
    };
  });

  tc.querySelectorAll("[data-equip]").forEach(btn=>{
    btn.onclick = () => {
      toggleEquip(btn.dataset.equip);
      save();
      renderCareer();
    };
  });

  tc.querySelectorAll("[data-lux]").forEach(btn=>{
    btn.onclick = () => {
      buyLuxury(btn.dataset.lux);
      save();
      renderCareer();
    };
  });

  tc.querySelectorAll("[data-sign]").forEach(btn=>{
    btn.onclick = () => {
      const idx = parseInt(btn.dataset.sign, 10);
      signOffer(idx);
      save();
      renderCareer();
    };
  });

  const decl = $("btnDeclareInline");
  if(decl){
    decl.onclick = () => {
      declareForDraft();
      save();
      renderCareer();
    };
  }

  const fa = $("btnEnterFA");
  if(fa){
    fa.onclick = () => {
      enterFreeAgency(false);
      save();
      renderCareer();
    };
  }

  const ext = $("btnRequestExtension");
  if(ext){
    ext.onclick = () => {
      requestExtension();
      save();
      renderCareer();
    };
  }

  const clear = $("btnClearLog");
  if(clear){
    clear.onclick = () => {
      if(state.ui.logEl) state.ui.logEl.textContent = "";
      logLine("Log cleared.");
    };
  }
}

function renderCareer(){
  if(!state.player){
    showScreen("home");
    return;
  }

  const sub =
    state.phase === "HS" ? `High School • Year ${state.year} • Week ${state.week} • Record ${state.seasonWins}-${state.seasonLosses}` :
    state.phase === "COLLEGE" ? `College • Year ${state.year} • Week ${state.week} • Record ${state.seasonWins}-${state.seasonLosses}` :
    state.phase === "DRAFT" ? `Draft • Ready to run draft logic` :
    state.phase === "PRO" ? `Pros • Season ${state.pro.seasonsPlayed + 1} • Week ${state.week} • Record ${state.seasonWins}-${state.seasonLosses}` :
    "";

  $("careerSub").textContent = sub;

  renderBars();
  renderPlayerCard();
  renderTab();
}

/* ---------------- Fix: Enter College cash carry (HS money) ---------------- */
const _enterCollege_original = enterCollege;
enterCollege = function(collegeId){
  // preserve HS money before enterCollege mutates pools
  const hsCash = state.life.money || 0;

  state.phase = "COLLEGE";
  state.college.collegeId = collegeId;
  const c = COLLEGES.find(x=>x.id===collegeId);
  state.college.confId = c?.confId || null;

  state.year = 1;
  state.week = 1;
  state.life.fatigue = 18;
  state.life.grades = clamp(state.life.grades + 6, 0, 100);
  state.life.social = clamp(state.life.social + 3, 0, 100);

  state.college.money = Math.max(0, state.college.money || 0);

  // carry HS cash into college pool
  state.college.money += hsCash;
  state.life.money = state.college.money;

  state.college.inventory = state.college.inventory || [];
  state.college.equipped = state.college.equipped || {};

  logLine(`Enrolled at ${c?.name || "College"} (${c?.stars || "?"}⭐)`);
  initCollegeSeason();
  save();
  renderCareer();
};

/* ---------------- UI Wiring ---------------- */
function wireTabs(){
  const tabs = ["overview","season","recruit","shop","contract","logs"];
  tabs.forEach(t=>{
    const btn =
      t==="overview" ? $("tabOverview") :
      t==="season" ? $("tabSeason") :
      t==="recruit" ? $("tabRecruit") :
      t==="shop" ? $("tabShop") :
      t==="contract" ? $("tabContract") :
      $("tabLogs");
    if(btn){
      btn.onclick = () => setActiveTab(t);
    }
  });
}

function wireCareerButtons(){
  $("btnTrain").onclick = () => { doTrain(); save(); renderCareer(); };
  $("btnStudy").onclick = () => { doStudy(); save(); renderCareer(); };
  $("btnSocial").onclick = () => { doSocial(); save(); renderCareer(); };
  $("btnWork").onclick = () => { doWork(); save(); renderCareer(); };
  $("btnAdvanceWeek").onclick = () => { advanceWeek(); };
  $("btnSave").onclick = () => { save(); renderCareer(); };
}

function rebuildBuilderFromInputs(preserveAlloc=true){
  const pos = $("bPos").value;
  const height = $("bHeight").value;
  const weight = parseInt($("bWeight").value||"200",10);
  const age = parseInt($("bAge").value||"15",10);

  // ensure archetypes exist for pos
  fillArchetypesForPos(pos);
  if($("bArch").value) builder.archId = $("bArch").value;

  const base = baseRatingsFromPhysical(pos, height, weight, age);
  const arch = getArchetype(pos, builder.archId);
  builder.caps = arch?.caps || { speed:99,strength:99,agility:99,awareness:99,stamina:99 };

  // boosted baseline (free boosts)
  const boosted = {...base};
  for(const [k,v] of Object.entries(arch?.boosts || {})){
    boosted[k] = clamp(boosted[k] + v, builder.min, builder.caps[k]);
  }

  if(!builder.ratings || !builder.start || !preserveAlloc){
    builder.start = {...boosted};
    builder.ratings = {...boosted};
  } else {
    const deltas = {};
    for(const k of Object.keys(builder.start)){
      deltas[k] = (builder.ratings[k] - builder.start[k]);
    }
    builder.start = {...boosted};
    builder.ratings = {...boosted};
    for(const k of Object.keys(builder.ratings)){
      builder.ratings[k] = clamp(builder.ratings[k] + (deltas[k]||0), builder.start[k], builder.caps[k]);
    }
  }

  $("capSpeed").textContent = `(cap ${builder.caps.speed})`;
  $("capStrength").textContent = `(cap ${builder.caps.strength})`;
  $("capAgility").textContent = `(cap ${builder.caps.agility})`;
  $("capAwareness").textContent = `(cap ${builder.caps.awareness})`;
  $("capStamina").textContent = `(cap ${builder.caps.stamina})`;

  renderBuilderRatings(pos);
}

function wireBuilder(){
  // rating +/- buttons
  document.querySelectorAll(".rating-controls button").forEach(btn=>{
    const attr = btn.dataset.attr;
    const dir = parseInt(btn.dataset.dir, 10);
    if(!attr || !dir) return;
    btn.onclick = () => {
      tryAdjustRating(attr, dir);
      renderBuilderRatings($("bPos").value);
    };
  });

  $("bPos").onchange = () => {
    // keep step + allocations if possible
    rebuildBuilderFromInputs(false);
  };
  $("bHeight").onchange = () => rebuildBuilderFromInputs(true);
  $("bWeight").oninput = () => rebuildBuilderFromInputs(true);
  $("bAge").oninput = () => rebuildBuilderFromInputs(true);

  $("bArch").onchange = () => {
    builder.archId = $("bArch").value;
    rebuildBuilderFromInputs(true);
  };

  $("btnBack").onclick = () => {
    if(builder.step === 1){
      showScreen("home");
      return;
    }
    setBuilderStep(builder.step - 1);
  };

  $("btnNext").onclick = () => {
    if(builder.step < 3){
      setBuilderStep(builder.step + 1);
      if(builder.step === 3){
        // ensure ratings initialized for step 3
        rebuildBuilderFromInputs(false);
      }
      return;
    }
    // step 3 -> start career
    finalizeCareer();
  };
}

/* ---------------- App Boot ---------------- */
function boot(){
  $("btnNew").onclick = () => startBuilder();
  $("btnWipe").onclick = () => {
    const ok = confirm("Wipe local save for Gridiron Career Sim?");
    if(ok) wipe();
    $("jsStatus").textContent = "save wiped";
  };

  $("btnContinue").onclick = () => {
    const ok = load();
    if(ok){
      showScreen("career");
      // default tab if missing
      state.ui.activeTab = state.ui.activeTab || "overview";
      renderCareer();
      $("jsStatus").textContent = "save loaded";
    } else {
      showScreen("home");
      $("jsStatus").textContent = "no save found";
      alert("No save found. Click New Career to start.");
    }
  };

  buildHeightOptions();
  wireTabs();
  wireCareerButtons();
  wireBuilder();

  // start screen
  if(load()){
    showScreen("career");
    state.ui.activeTab = state.ui.activeTab || "overview";
    renderCareer();
    $("jsStatus").textContent = "save loaded";
  } else {
    showScreen("home");
    $("jsStatus").textContent = "ready";
  }
}

document.addEventListener("DOMContentLoaded", boot);

"""  # <- closes game_js raw string

# =========================
# Files + ZIP output
# =========================
index_path = os.path.join(base_dir, "index.html")
css_path   = os.path.join(base_dir, "style.css")
js_path    = os.path.join(base_dir, "game.js")

with open(index_path, "w", encoding="utf-8") as f:
  f.write(index_html)

with open(css_path, "w", encoding="utf-8") as f:
  f.write(style_css)

with open(js_path, "w", encoding="utf-8") as f:
  f.write(game_js)

zip_path = "/mnt/data/football-sim-v05.zip"
with zipfile.ZipFile(zip_path, "w", compression=zipfile.ZIP_DEFLATED) as z:
  z.write(index_path, arcname="index.html")
  z.write(css_path, arcname="style.css")
  z.write(js_path, arcname="game.js")

zip_path
